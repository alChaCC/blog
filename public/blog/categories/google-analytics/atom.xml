<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Google Analytics | AlohaCC]]></title>
  <link href="http://ccaloha.cc/blog/categories/google-analytics/atom.xml" rel="self"/>
  <link href="http://ccaloha.cc/"/>
  <updated>2015-02-26T23:39:36+08:00</updated>
  <id>http://ccaloha.cc/</id>
  <author>
    <name><![CDATA[Aloha]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Using Google Analytics for Email Click Tracking And Open Rate Tracking in Ruby on Rails]]></title>
    <link href="http://ccaloha.cc/blog/2015/02/27/using-google-analytics-for-email-click-tracking-and-open-rate-tracking-in-ruby-on-rails/"/>
    <updated>2015-02-27T23:34:39+08:00</updated>
    <id>http://ccaloha.cc/blog/2015/02/27/using-google-analytics-for-email-click-tracking-and-open-rate-tracking-in-ruby-on-rails</id>
    <content type="html"><![CDATA[<h2>Requirement</h2>

<ol>
<li><p>每個連結的點擊數</p></li>
<li><p>開信率</p></li>
</ol>


<h2>Google Analytics</h2>

<p>這是一個電子報，基本上屬於一種廣告！</p>

<p>那GA怎麼那麼厲害知道誰點了什麼？</p>

<p>該不會Google 大神，連Email也滲透？！</p>

<p>ps. 我猜他應該也差不多都知道我們在Email上的一舉一動，只要你用Gmail...</p>

<h3>那GA要怎麼紀錄？</h3>

<blockquote><p>基本上就是將<strong>連結網址</strong>帶上一些"參數"，當使用者點了這個連結之後，就你就會被帶到那個<strong>連結網址</strong>，這時候那個網站一定有埋GA的javascript
，這就是他的Key~ GA透過js爬到你的網址，當他發現你有帶某些參數，他就知道你是從哪裡來的！</p></blockquote>

<!-- more -->


<p>我剛剛提到了好幾次<strong>參數</strong></p>

<p>沒錯！這就是關鍵！</p>

<p>讓我們來看一下 有哪些參數</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/utm%E8%A8%AD%E8%A8%88.png"></p>

<p>GA在有文件說明<a href="https://support.google.com/analytics/answer/1033863">網址要如何使用</a></p>

<p>而且，GA還很貼心的幫大家準備了 <a href="https://support.google.com/analytics/answer/1033867?hl=zh-Hant">網址產生器</a></p>

<p>來看一下，實際上會產生什麼樣的連結：</p>

<p>假設我們追蹤</p>

<pre><code>透過Email點擊，來到首頁的人
</code></pre>

<p>Url 原本是長這樣</p>

<pre><code>www.urcosme.com
</code></pre>

<p>ps. urcosme.com小弟目前待的公司 XDDDDD廣告一下！</p>

<p>經過<del>我的</del>GA的巧手，它會長這樣</p>

<pre><code>www.urcosme.com/?utm_source=%E9%9B%BB%E5%AD%90%E5%A0%B1&amp;utm_medium=%E9%9B%BB%E5%AD%90%E9%83%B5%E4%BB%B6&amp;utm_content=%E6%B8%AC%E8%A9%A6%E6%B8%AC%E8%A9%A6&amp;utm_campaign=%E6%88%91%E5%A5%BD%E5%B8%A5
</code></pre>

<p>案....這是....!？</p>

<p>讓我幫你翻譯一下</p>

<pre><code>www.urcosme.com/?utm_source=電子報&amp;utm_medium=電子郵件&amp;utm_content=測試測試&amp;utm_campaign=我好帥
</code></pre>

<p>當我把連結改成這樣後，基本上使用者也是會點到你的首頁，但是對於GA而言，他就知道你是從電子郵件過來</p>

<p>但! 身為一個有責任感又假掰的IT，</p>

<p>我們當然希望讓系統自動幫行銷的同仁帶入這些參數，讓正妹同事覺得沒有你不行～</p>

<h2>1. Rails 要如何實作“點擊追蹤”</h2>

<p>其實很簡單，我們要寫一個 小小小爬蟲，把內容爬過一次</p>

<p>把有 &lt;a> 的找出來，然後把資訊加進去就好了！</p>

<p>那...爬蟲要怎麼寫？</p>

<p>各位，既然是來到 Rails ，Rails什麼不多，鐵路最多，歐不～ 是輪子最多！</p>

<p>跟大家介紹個 Gem : <strong><a href="http://www.nokogiri.org/">Nokogiri</a></strong></p>

<p>我們就直接用實作，來說明他可以幹麻</p>

<p>直接來看的程式碼：</p>

<p>這是我寫在 <strong>app/models/edm.rb</strong> 的code</p>

<p>這個model資訊是這樣</p>

<pre><code># == Schema Information
#
# Table name: edms
#
#  id                 :integer          not null, primary key
#  name               :string
#  send_at            :datetime
#  title              :string(255)
#  state              :string(255)
#  content            :text
#  created_at         :datetime
#  updated_at         :datetime
#


def parse_link_in_email(user_id)
    # 讀進email html
    html =  Nokogiri::HTML(self.content)
    # 找出所有 a 
    a_nodes = html.css('a')
    a_nodes.each do |a|
      # 抓出href 並且加上GA 追蹤
      tracking_a = a['href'] +  "?utm_source=#{self.name}-#{CGI.escape(a['href'])}" + 
                                "&amp;utm_medium=email" +
                                "&amp;utm_content=#{self.id}-#{user_id}" + 
                                "&amp;utm_campaign=#{self.title}"
      a['href'] = tracking_a
    end
    return html.to_html
 end
</code></pre>

<p>幾個重點：</p>

<ol>
<li>使用<strong>Nokogiri::HTML(self.content)</strong>  => 讀HTML進來</li>
<li><strong>html.css('a')</strong> => 抓出所有&lt;a></li>
<li><strong>a['href']</strong>     => 抓出這個&lt;a>，裡頭的屬性href</li>
<li><strong>html.to_html</strong>  => 轉回HTML</li>
</ol>


<p>Done !</p>

<p>所以當使用者點擊信件的link時，GA就會看到.....</p>

<p><strong>攬客 >> 廣告活動 >> 所有廣告活動</strong></p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/GA_email_click_tracking.png" alt="GA email click tracking demo"></p>

<h2>2. Rails 要如何實作“開信率”</h2>

<p>開信率我是參考這篇<a href="http://dyn.com/blog/tracking-email-opens-via-google-analytics/">Blog</a>來實作</p>

<p>簡單來說，我們需要埋一個image tag，然而那個tag</p>

<p>會帶上一些<strong>參數</strong>，讓GA知道這幹嘛的！</p>

<p>為什麼要使用這種標籤的方式紀錄呢？</p>

<p>假設使用者打開信之後，並且點了一個連結，</p>

<p>因為這個點了連結的動作，我們知道他一定有開信，歐噎～ 做完了～</p>

<p>But...........</p>

<p>那如果他只有打開信，沒有點擊勒？ 如果他打開信，點了N個連結，那開信不就也被多紀錄了很多次？(ps.點擊紀錄是每點一次就紀錄一次)</p>

<blockquote><p>所以我們必須透過從 Google Analytics <strong>"GET"</strong> 一個標記(就是圖片啦)，當我們跟GA要圖的時候，可以告訴GA一些<strong>參數</strong>，嘿嘿，這樣就有辦法紀錄了！</p></blockquote>

<p>各位，又看到<strong>參數</strong>兩個字</p>

<p>那又有哪些可以用勒？ (這邊我只列我目前有在用的，詳細可以參考<a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#events">GA collections parameters</a>)</p>

<table>
<thead>
<tr>
<th></th>
<th> 參數                                                                                 </th>
<th> 說明                                                                   </th>
<th> 舉例                                                                                 </th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td> tid </td>
<td> 要放GA的ID</td>
<td> UA-1234567-8 |</td>
</tr>
<tr>
<td></td>
<td> uid </td>
<td>Unique的ID(因為我們要寄信給User我是使用該User的ID)</td>
<td> 1 |</td>
</tr>
<tr>
<td></td>
<td> t   </td>
<td> 告訴GA這是個什麼類型的紀錄(基本上我查到都使用event) </td>
<td> event |</td>
</tr>
<tr>
<td></td>
<td> ec  </td>
<td> 告訴GA這個Event的Category </td>
<td> email-測試 |</td>
</tr>
<tr>
<td></td>
<td> ea  </td>
<td> 告訴GA這個Event的Action </td>
<td> Open |</td>
</tr>
<tr>
<td></td>
<td> el  </td>
<td> 告訴GA這個Event的Label </td>
<td> user_id-1 |</td>
</tr>
<tr>
<td></td>
<td> cs  </td>
<td> 廣告活動的來源 </td>
<td> Email標題 |</td>
</tr>
<tr>
<td></td>
<td> cm  </td>
<td> 廣告活動的媒介 </td>
<td> edm |</td>
</tr>
<tr>
<td></td>
<td> cn  </td>
<td> 廣告活動名稱   </td>
<td> 電子報第0期 | </td>
</tr>
</tbody>
</table>


<p>那我們就不看sample，直接來看實作code</p>

<pre><code>def parse_link_in_email(user_id)

    ... 

    body = html.at_css("body")
    img_node = Nokogiri::XML::Node.new("img",body)
    img_node['src'] = "https://www.google-analytics.com/collect?v=1" + 
                      "&amp;tid=#{Settings.google_analytics_key}" + 
                      "&amp;uid=#{user_id}"+
                      "&amp;t=event" +
                      "&amp;ec=email-#{self.name}-#{self.title}" + 
                      "&amp;ea=open" + 
                      "&amp;el=user_id-#{user_id}" + 
                      "&amp;cs=#{self.name}" + 
                      "&amp;cm=email" + 
                      "&amp;cn=#{self.title}"
    body &lt;&lt; img_node

    ...
end
</code></pre>

<p>幾個重點：</p>

<ol>
<li>使用<strong>Nokogiri::XML::Node.new("img",body)</strong>  => 新增一個&lt;img>標籤</li>
<li><strong>img_node['src']</strong>     => 設定這個&lt;img>，裡頭的屬性src</li>
<li><strong>body &lt;&lt; img_node</strong>  => 將code埋到body裡面</li>
</ol>


<p>那在GA你會看到什麼勒？</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/GA_email_open_tracking.png" alt="GA email open rate tracking demo"></p>

<h2>3. Rails Mailer、its View and model</h2>

<p> 剩下我沒提到的部份，不過這些就是基本寄信的功能，我就不贅述了</p>

<p> <strong>app/models/edm.rb</strong></p>

<pre><code>has_many :edm_user_ships  # 假設你有要寄信的清單
has_many :users, :through =&gt; :edm_user_ships
def send_mail
    self.users.each do |user|
        EdmMailer.delay.send_edm(self, user.email, user.id)
    end
end
</code></pre>

<p><strong>app/mailers/edm_mailer.rb</strong></p>

<pre><code>class EdmMailer &lt; ActionMailer::Base
  default from: "service@urcosme.com"

  def send_edm(e_notify, email, user_id = nil)
    @e_notify = e_notify
    @user_id = user_id

    mail to: email, subject: e_notify.title
  end
end
</code></pre>

<p><strong>app/views/edm_mailer/send_edm.html.slim</strong></p>

<pre><code>= raw @e_notify.parse_link_in_email(@user_id)
</code></pre>

<h2>Done</h2>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[HowTo] Get Google Analytics Engagement Using R]]></title>
    <link href="http://ccaloha.cc/blog/2014/12/26/howto-get-google-analytics-engagement-using-r/"/>
    <updated>2014-12-26T08:17:04+08:00</updated>
    <id>http://ccaloha.cc/blog/2014/12/26/howto-get-google-analytics-engagement-using-r</id>
    <content type="html"><![CDATA[<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/get%20google%20analytics%20engagement%20using%20R/2014%E5%B9%B4engagement-pageviews%E5%9C%96.png" alt="every months google analytic engagement(pageviews X session Duration) in 2014 using R"></p>

<p><strong>使用者在網站上的參與程度</strong>，是我一直滿好奇的指標！</p>

<p>在GA裡，網站參與度，如下圖</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/get%20google%20analytics%20engagement%20using%20R/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-22%20%E4%B8%8A%E5%8D%883.13.48.png" alt=“google analytics engagement”></p>

<p>這系列的文章，我的target是 我想知道今年(2014)整體使用者參與度的變化與趨勢</p>

<p>此篇文章是focus 在如何透過R抓取資料並分析成和 GA view一樣的資料！</p>

<p>之後，再看看可以看到什麼樣比較有意義的資料～</p>

<p>let's go !</p>

<!-- more -->


<h2>Google Analytic API 申請</h2>

<p>在做GA之前，別忘記要申請<strong><a href="http://ccaloha.herokuapp.com/blog/2014/12/24/howto-get-google-analytics-using-r-rgoogleanalytics-using-users-pageviews-time-as-an-example/">GA API權限</a></strong></p>

<h2>Google Query Explorer <a href="https://ga-dev-tools.appspot.com/explorer/">link</a></h2>

<p>Google 提供的工具，我覺得還滿好用的！</p>

<p>在使用API之前，使用 explorer 可以讓你先有Fu大概知道會拿到什麼樣的資料！</p>

<p>大概看一下怎麼用吧</p>

<h3>Step1. 先登入Google Analytics的帳號</h3>

<h3>Step2. 回到Google Query Explorer，重新refresh</h3>

<p>點選認證</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/get%20google%20analytics%20engagement%20using%20R/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-25%20%E4%B8%8A%E5%8D%888.16.31.png" alt="點選 Click Here to authorize"></p>

<p>你就可以看到</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/get%20google%20analytics%20engagement%20using%20R/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-25%20%E4%B8%8A%E5%8D%888.20.28.png" alt="Google Query Explorer 取得GA權限後頁面"></p>

<p>其中，<strong>account</strong> /  <strong>Property</strong> / <strong>View(Profile)</strong> 就是</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/get%20google%20analytics%20engagement%20using%20R/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-25%20%E4%B8%8A%E5%8D%888.24.24.png" alt="對應GA"></p>

<h3>Step3. 看一下哪些GA View 對應到API的名稱</h3>

<p>請到 <a href="https://developers.google.com/analytics/devguides/reporting/core/dimsmets">Google Analytics Dimensions &amp; Metrics Reference</a></p>

<p>我們要找的就是</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/get%20google%20analytics%20engagement%20using%20R/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-26%20%E4%B8%8A%E5%8D%887.46.24.png" alt="Sessions"></p>

<p>點進去<strong>"ga:sessionDurationBucket"</strong></p>

<p>你會看到 <strong>“web view name: Session Duration”</strong> 沒錯！ 那個就是對應到GA View的名稱！</p>

<p>耶～～找到了～～</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/get%20google%20analytics%20engagement%20using%20R/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-26%20%E4%B8%8A%E5%8D%887.48.45.png" alt="ga:sessionDurationBucket definition"></p>

<h3>Step4. 找到之後，趕緊來Google Query Explorer試試抓數據的感覺</h3>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/get%20google%20analytics%20engagement%20using%20R/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-22%20%E4%B8%8A%E5%8D%883.20.14.png" alt="fetch data from google query explorer"></p>

<p>ya~~~拿到資料了！</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/get%20google%20analytics%20engagement%20using%20R/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-26%20%E4%B8%8A%E5%8D%887.54.52.png" alt="get ga:sessionDurationBucket , ga:sessions and ga:sessionDuration from Google Query Explorer"></p>

<p>咦！那個<strong>ga:sessionDurationBucket</strong>好像有點怪怪的～</p>

<p>各位人客，請不要緊張～</p>

<p>那是因為他吐回來的資料是<strong>String</strong>，所以他的排序才是這樣～</p>

<h3>Step5. R</h3>

<p>說明都寫在裡面！</p>

<p>ps. 由於小弟我還是R新手，寫的鳥鳥的地方，還請見諒，如果可以的話，可以留言告訴我，哪裡怎麼寫會比較好～ 感謝！</p>

<p><a href="https://gist.github.com/alChaCC/4fee2a25a422dceb40f5">點我看比較漂亮的gist</a></p>

<pre><code>setwd("r-playground/R/ga_engagement") #設定你要的操作順序
list.of.packages &lt;- c("rjson", "RCurl","RGoogleAnalytics")
new.packages &lt;- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
require(rjson)
require(RCurl)
require(RGoogleAnalytics)
require(ggplot2)
token &lt;- Auth('YOUR API USER ID','YOUR API USER PASSWORD')
save(token,file="./token_file")
profile &lt;- GetProfiles(token) # show all your profile 
#          id                               name
#    XXXXXX                      HELLO (All)
#  YYYYYYYY                      COOL
#   ....

# Your profile number (not the GA ID number)
my_profile    &lt;- profile[profile$name == 'HELLO (All)',1] 

time_start_seq &lt;- as.Date(ISOdate(2014,seq(1,12),1))
#[1] "2014-01-01" "2014-02-01" "2014-03-01" "2014-04-01" "2014-05-01" "2014-06-01"
#[7] "2014-07-01" "2014-08-01" "2014-09-01" "2014-10-01" "2014-11-01" "2014-12-01"
time_end_seq &lt;- seq(as.Date("2014-02-01"), length=12, by="1 month") - 1
# [1] "2014-01-31" "2014-02-28" "2014-03-31" "2014-04-30" "2014-05-31" "2014-06-30"
# [7] "2014-07-31" "2014-08-31" "2014-09-30" "2014-10-31" "2014-11-30" "2014-12-31"

# 為了做資料紀錄
every_month_2014 &lt;- list()
all_data &lt;- data.frame()

for ( i in 1:length(time_start_seq)) {

  query.list &lt;- Init(start.date = as.character(time_start_seq[i]),
                     end.date = as.character(time_end_seq[i]),
                     dimensions = "ga:sessionDurationBucket",
                     metrics = "ga:sessions,ga:pageviews",
                     sort = "ga:sessionDurationBucket",
                     max.results = 10000,
                     table.id = paste("ga:",my_profile,sep="",collapse=",")
                     )

  # 建立一個query等一下就是透過這個query與token拿資料！
  ga.query &lt;- QueryBuilder(query.list)

  # 向GA抓取資料，存成data frame
  ga.data &lt;- GetReportData(ga.query, token) 
  # ga.data &lt;- GetReportData(ga.query, token,split_daywise = T,paginate_query = TRUE)  另外一種拿法也work


  # 資料處理部分，由於抓回來的 “data$sessionDurationBucket” 是個string，所要把它轉成 數字
  less_than_10_seconds &lt;- ga.data[as.numeric(ga.data$sessionDurationBucket) &lt;= 10,]
  between_11_to_30     &lt;- ga.data[as.numeric(ga.data$sessionDurationBucket) &gt; 10 &amp; as.numeric(ga.data$sessionDurationBucket) &lt;= 30,]
  between_31_to_60     &lt;- ga.data[as.numeric(ga.data$sessionDurationBucket) &gt; 30 &amp; as.numeric(ga.data$sessionDurationBucket) &lt;= 60,]
  between_61_to_180    &lt;- ga.data[as.numeric(ga.data$sessionDurationBucket) &gt; 60 &amp; as.numeric(ga.data$sessionDurationBucket) &lt;= 180,]
  between_181_to_600   &lt;- ga.data[as.numeric(ga.data$sessionDurationBucket) &gt; 180 &amp; as.numeric(ga.data$sessionDurationBucket) &lt;= 600,]
  between_601_to_1800  &lt;- ga.data[as.numeric(ga.data$sessionDurationBucket) &gt; 600 &amp; as.numeric(ga.data$sessionDurationBucket) &lt;= 1800,]
  more_than_1801       &lt;- ga.data[as.numeric(ga.data$sessionDurationBucket) &gt; 1800,]

  # 處理後資料長這樣
  #     sessionDurationBucket sessions pageviews
  #                        0   342840    341561
  #                        1     1445      1906
  #                       10     2567      4392
  #                        2     2210      2704
  #                        3     2283      2934
  #                        4     2309      3133
  #                        5     2368      3384


  # 資料整併
  every_month_2014[[i]] &lt;- rbind(colSums(less_than_10_seconds[,-1]),colSums(between_11_to_30[,-1]),
                                 colSums(between_31_to_60[,-1]),colSums(between_61_to_180[,-1]),
                                 colSums(between_181_to_600[,-1]),colSums(between_601_to_1800[,-1]),
                                 colSums(more_than_1801[,-1]))
  #       sessions pageviews
  #[1,]   365814    375361
  #[2,]    44857     92466
  #[3,]    48003    133645
  #[4,]    96890    423865
  #[5,]   107373    872529
  #[6,]    78404   1057353
  #[7,]    28183    812783


  # 補上一欄時間區間
  month_all_data &lt;- cbind(c(as.character(i)),c("&lt; 10s","11 ~ 30","31~60","61~180","181~600","601~1800","&gt;1801"),every_month_2014[[i]])
  #                     sessions pageviews
  #[1,] "12" "&lt; 10s"    "365814" "375361" 
  #[2,] "12" "11 ~ 30"  "44857"  "92466"  
  #[3,] "12" "31~60"    "48003"  "133645" 
  #[4,] "12" "61~180"   "96890"  "423865" 
  #[5,] "12" "181~600"  "107373" "872529" 
  #[6,] "12" "601~1800" "78404"  "1057353"
  #[7,] "12" "&gt;1801"    "28183"  "812783" 

  # 將每一年的統整資料放在一起，作圖需要
  all_data &lt;- rbind(all_data,month_all_data)
}


# 補上欄位名稱
colnames(all_data) &lt;- c("month","time_interval","sessions","pageviews")


# 先畫pageviews
# 將資料的型態改正，因為上面建立的時候，會將每個欄位的屬性變成"factor"，這會對畫圖趙成莫大影響！
all_data &lt;- transform(all_data, 
    time_interval = factor(time_interval, levels = 
        c('&lt; 10s','11 ~ 30','31~60', '61~180','181~600', '601~1800','&gt;1801')),
    pageviews = as.numeric(as.character(pageviews)))

# 作圖
plot &lt;- ggplot(data = all_data, aes(x = month, y = pageviews, fill = time_interval)) +  
    geom_bar(stat = "identity", position = "dodge", colour = "black")

# 將圖存出
ggsave(plot,file=paste("2014年engagement-pageviews圖.png",sep=""),width=15, height=10)


# 再畫sessions
all_data &lt;- transform(all_data, 
    time_interval = factor(time_interval, levels = 
        c('&lt; 10s','11 ~ 30','31~60', '61~180','181~600', '601~1800','&gt;1801')),
    sessions = as.numeric(as.character(sessions)))

plot &lt;- ggplot(data = all_data, aes(x = month, y = sessions, fill = time_interval)) +  
    geom_bar(stat = "identity", position = "dodge", colour = "black")

ggsave(plot,file=paste("2014年engagement-sessions圖.png",sep=""),width=15, height=10)
</code></pre>

<h3>Done</h3>

<p>先來看 2014年每月 pageview 與 使用者平均在線時間 的 bar chart</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/get%20google%20analytics%20engagement%20using%20R/2014%E5%B9%B4engagement-pageviews%E5%9C%96.png" alt="every months google analytic engagement(pageviews X session Duration) in 2014 using R"></p>

<p>再來看 2014年每月 sessions 與 使用者平均在線時間 的 bar chart</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/get%20google%20analytics%20engagement%20using%20R/2014%E5%B9%B4engagement-sessions%E5%9C%96.png" alt="every months google analytic engagement(sessions X session Duration) in 2014 using R"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[HOWTO]- 立馬拋棄Excel！利用R，取得Google Analytics的資料 -以使用者流量的時間畫heatmap為example]]></title>
    <link href="http://ccaloha.cc/blog/2014/12/24/howto-get-google-analytics-using-r-rgoogleanalytics-using-users-pageviews-time-as-an-example/"/>
    <updated>2014-12-24T10:24:04+08:00</updated>
    <id>http://ccaloha.cc/blog/2014/12/24/howto-get-google-analytics-using-r-rgoogleanalytics-using-users-pageviews-time-as-an-example</id>
    <content type="html"><![CDATA[<blockquote><p>學習一個東西，最快的方式，就是....</p>

<blockquote><p>just do it !</p></blockquote></blockquote>

<p>由於我想要成為一個酷炫的資料科學家！</p>

<p>不學習R這樣對嗎～</p>

<p>既然要學習R，那從每週的<strong>Google Analytics</strong>開始著手！</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/HowTo-%20get%20google%20analytics%20using%20R%28RGoogleAnalytics%29%20using%20user%27s%20pageviews%20time%20as%20an%20example/Rplot.png" alt="traffic heatmap using R (RGoogleAnalytics)"></p>

<!-- more -->


<p>首先，在開始之前，為了要有個map !</p>

<p>所以，當然是先看人家怎麼做</p>

<p>瞭解一下機制和 那個Fu~~</p>

<p>我主要是參考這篇：<a href="http://viget.com/inspire/how-to-build-a-traffic-heatmap-using-google-analytics-and-r">Building a Traffic Heatmap with Google Analytics and R</a></p>

<p>但是由於他使用的 RGoogleAnalytics 是舊版的，而且，google 現在的API都需要使用 OAuth 2.0</p>

<p>所以....做法上還是有點不同，不過完成整個設定後，擷取資料與分析，就跟他的內容大同小異了！</p>

<p>廢話不多說，那就開始吧！</p>

<h2>Step 1. 申請API使用權限</h2>

<h3>1. 登入到 <a href="http://cloud.google.com/console">Google Developer Console</a></h3>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/HowTo-%20get%20google%20analytics%20using%20R%28RGoogleAnalytics%29%20using%20user%27s%20pageviews%20time%20as%20an%20example/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-24%20%E4%B8%8B%E5%8D%8811.16.19.png" alt="建立專案"></p>

<h3>2. 選擇啟用API</h3>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/HowTo-%20get%20google%20analytics%20using%20R%28RGoogleAnalytics%29%20using%20user%27s%20pageviews%20time%20as%20an%20example/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-24%20%E4%B8%8B%E5%8D%8811.16.31.png" alt="設定啟用API"></p>

<h3>3. 選擇要啟用的API 為 google analytics</h3>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/HowTo-%20get%20google%20analytics%20using%20R%28RGoogleAnalytics%29%20using%20user%27s%20pageviews%20time%20as%20an%20example/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-24%20%E4%B8%8B%E5%8D%8811.16.35.png" alt="選擇要請用的API為 Analytics API"></p>

<h3>4. 新增API存取所需的憑證</h3>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/HowTo-%20get%20google%20analytics%20using%20R%28RGoogleAnalytics%29%20using%20user%27s%20pageviews%20time%20as%20an%20example/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-24%20%E4%B8%8B%E5%8D%8811.16.45.png" alt="建立API憑證"></p>

<h3>5. 輸入相關資訊</h3>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/HowTo-%20get%20google%20analytics%20using%20R%28RGoogleAnalytics%29%20using%20user%27s%20pageviews%20time%20as%20an%20example/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-24%20%E4%B8%8B%E5%8D%8811.16.52.png" alt="輸入這個憑證的相關訊息"></p>

<h3>6. 記錄下來你的用戶ID與用戶密碼</h3>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/HowTo-%20get%20google%20analytics%20using%20R%28RGoogleAnalytics%29%20using%20user%27s%20pageviews%20time%20as%20an%20example/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-12-24%20%E4%B8%8B%E5%8D%8811.17.02.png" alt="記錄下來吧！"></p>

<h2>Step2. 寫R</h2>

<p>請看我裡面的註解吧</p>

<pre><code># 安裝套件
install.packages('rjson')
install.packages('RCurl')
install.packages('RColorBrewer')
install.packages('RGoogleAnalytics')
require(rjson)
require(RCurl)
require(RColorBrewer)
require(RGoogleAnalytics)

# 由於 google api 現在規定使用oauth2.0 來存取
# R語言使用 "&lt;-" 當作變數指派
token &lt;- Auth('用戶端ID','用戶端密碼')

# 找到目前有哪些views
profile &lt;- GetProfiles(token)

## 上面那一行你會看到這樣的結果，使用data.frame格式儲存，data frame是R語言裡頭很常見的資料型態，你就把它想成是excel裡面的tab
## id name
## 85712839 所有網站資料

# 編寫要搜尋的參數，這邊是關鍵！
# R： 取得data frame 列(row)裡頭一個變數
my_profile &lt;- profile[profile$name == '所有網站資料',1]
query.list &lt;- Init(start.date = "2014-10-01",
          end.date = "2014-12-14",
          dimensions = "ga:dayOfWeek, ga:hour",
          metrics = "ga:pageviews",
          max.results = 10000,
          table.id = paste("ga:",my_profile,sep="",collapse=",")
)

# 建立一個query等一下就是透過這個query與token拿資料！
ga.query &lt;- QueryBuilder(query.list)

# 向GA抓取資料，存成data frame
ga.data &lt;- GetReportData(ga.query, token)

# 看一下ga.data長什麼樣子
## dayOfWeek hour pageviews
## 0 00 19734
## 0 01 11244
## 0 02 6286
## 0 03 3528
## 0 04 1830
## 0 05 1316
## 0 06 910
## 0 07 2168
## 0 08 4547
## ....


# 把ga.data裡頭dayOfWeek的 0 轉換成 sunday, 1轉成 Monday..and so on..
ga.data$dayOfWeek &lt;- as.character(ga.data$dayOfWeek)
ga.data$dayOfWeek[ga.data$dayOfWeek == "0"] &lt;- "Sunday"
ga.data$dayOfWeek[ga.data$dayOfWeek == "1"] &lt;- "Monday"
ga.data$dayOfWeek[ga.data$dayOfWeek == "2"] &lt;- "Tuesday"
ga.data$dayOfWeek[ga.data$dayOfWeek == "3"] &lt;- "Wednesday"
ga.data$dayOfWeek[ga.data$dayOfWeek == "4"] &lt;- "Thursday"
ga.data$dayOfWeek[ga.data$dayOfWeek == "5"] &lt;- "Friday"
ga.data$dayOfWeek[ga.data$dayOfWeek == "6"] &lt;- "Saturday"

# 資料排序調整(y軸)，寫了這個factor後，他會以 sunday, monday....等方式排序呈現資料
ga.data$dayOfWeek &lt;- factor(ga.data$dayOfWeek, levels = c("Sunday",
              "Monday",
              "Tuesday",
              "Wednesday",
              "Thursday",
              "Friday",
              "Saturday"))
ga.data[order(ga.data$dayOfWeek),]

# 將 data frame 轉成 xtab.
heatmap_data &lt;- xtabs(pageviews ~ dayOfWeek + hour, data=ga.data)

# heatmap_data長這樣
# hour
#dayOfWeek 00 01 02 03 04 05 06 07 08 09 10 11 12
# Sunday 19734 11244 6286 3528 1830 1316 910 2168 4547 5991 10653 11380 13414
# Monday 15170 9317 5120 2252 578 536 860 1605 3127 6175 10248 12287 12654
# Tuesday 11958 7445 3438 1582 893 784 904 1566 3268 6106 7925 7577 9336
# Wednesday 11178 7898 3529 1338 1177 536 844 1250 2575 6104 8051 8910 8732
# Thursday 28735 19955 9645 5246 2498 2072 3379 6070 9987 17166 22617 22780 23911
# Friday 31564 16496 8220 3603 2209 1626 2028 3015 6750 12871 17537 18307 18358
# Saturday 19325 12335 6011 2808 1253 1416 1090 1981 4114 7257 9239 10438 11733


# 畫圖 ---------------------------------------------------------------------
heatmap(heatmap_data,
col=colorRampPalette(brewer.pal(9,"Reds"))(100), # Use ColorBrewer's nicer color palettes.
revC=TRUE, # Start the week at the top of the Y axis.
scale="none", # Map color density to entire week, not a day or hour slice.
Rowv=NA, Colv=NA, # Don't use a dendogram.
main="Pageviews by Day and Hour", # Title.
xlab="Hour") # X-axis label. 
</code></pre>

<h2>Done</h2>

<p>執行指令，</p>

<pre><code>source('r_ga_heatmap.R')
</code></pre>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/HowTo-%20get%20google%20analytics%20using%20R%28RGoogleAnalytics%29%20using%20user%27s%20pageviews%20time%20as%20an%20example/Rplot.png" alt="traffic heatmap using R (RGoogleAnalytics)"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Google Analytics - Goal and Funnel]]></title>
    <link href="http://ccaloha.cc/blog/2014/12/18/google-analytics-goal-and-funnel/"/>
    <updated>2014-12-18T08:20:45+08:00</updated>
    <id>http://ccaloha.cc/blog/2014/12/18/google-analytics-goal-and-funnel</id>
    <content type="html"><![CDATA[<p>屬於四大分類下的........</p>

<p>Audience(目標對象)</p>

<p>Acquistion(攬客)</p>

<p>Behavior(行為)</p>

<blockquote><p><strong>Conversions(轉換)</strong></p></blockquote>

<p>一樣先來看看GA怎麼說</p>

<iframe width="560" height="315" src="http://ccaloha.cc//www.youtube.com/embed/fMeKXsl7xT8" frameborder="0" allowfullscreen></iframe>




<!-- more -->


<p></p>

<h2>Why => 目標與程序可以當飯吃嗎？</h2>

<blockquote><p><strong>可以！</strong></p>

<p>Aloha: 你可以設定目標，然後審閱使用者們到達這目標的比例是幾多。</p>

<p>畢竟你架個網站、加個功能、加個頁面，無非就是為了某些目的！例如，你希望使用者會導購EC</p></blockquote>

<p>這樣有FU了之後，我們來看一下GA上要怎麼設定～</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/GA/GA%E7%9B%AE%E6%A8%99%E8%88%87%E7%A8%8B%E5%BA%8F-1.png" alt="目標程序設定"></p>

<h3>目標網址</h3>

<p>當然就是填入 <strong>你希望使用者最後抵達的位置</strong></p>

<h3>值</h3>

<p>你可以設定 目標成功後的價值</p>

<h3>程序</h3>

<p>就是你預期它到達這個目標之前的路徑</p>

<p>當你設定了這個步驟後，就可以看到一個很酷的圖！</p>

<h3>Aloha眉批：</h3>

<p>以上面的圖為例子，假設我們希望使用者可以加入會員，所以我們可能做了一個活動，或是我們在步驟1, 步驟2做了調整，希望增加註冊成功的機會;</p>

<p>或者是說，你想知道目前的註冊流程的抵達比例，你也可以先設定好，再看看要怎麼請IT調整</p>

<p>於是乎，當我設定好程序後，我就可以看到</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/GA/GA%E7%9B%AE%E6%A8%99%E8%88%87%E7%A8%8B%E5%BA%8F-2.png" alt="GA-目"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Google Analytics - Cross Device tracking in Ruby on Rails]]></title>
    <link href="http://ccaloha.cc/blog/2014/12/12/google-analytics-cross-device-tracking-in-ruby-on-rails/"/>
    <updated>2014-12-12T08:13:38+08:00</updated>
    <id>http://ccaloha.cc/blog/2014/12/12/google-analytics-cross-device-tracking-in-ruby-on-rails</id>
    <content type="html"><![CDATA[<p>首先，先來看一下google 的說明</p>

<iframe width="560" height="315" src="http://ccaloha.cc//www.youtube.com/embed/RsrAcxIsQHU" frameborder="0" allowfullscreen></iframe>




<!-- more -->


<blockquote><p>簡單來說，GA 在不同裝置瀏覽時，會依照每個裝置製作特別的ID, 但是，當user清掉Cookie或是重新安裝機器，就會把那個特別的ID重設，這樣他就會變成新訪客，而不是回流訪客。</p></blockquote>

<p>當然，如果要跨Devise追蹤，既然是不同的Devise當然它的ID一定不一樣，所以一個使用者如果用電腦先在Urcosme網頁看一下等一下想要購買的商品，之後，他出發到康是美，要買產品之前拿出手機，再看一次商品確認，基本上他就會被列為兩個不同的來源</p>

<p>所以要跨Device追蹤，很重要的關鍵是：</p>

<blockquote><p>那個特別的ID</p></blockquote>

<p>然而，Universal(新版)的GA有提供修改 user id的功能！</p>

<p><a href="http://cutroni.com/blog/2014/04/10/understanding-cross-device-measurement-and-the-user-id/">Understanding Cross Device Measurement and the User-ID</a></p>

<h2>那要怎麼加上user id 呢？</h2>

<h3>Step1. 第一步，打開User ID的功能</h3>

<p><img alt="GA User ID" src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/GA/user%20id%20%E5%95%9F%E7%94%A8.png"></img></p>

<h3>Step2. 改網站上的Code</h3>

<p><img alt="GA User ID code" src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/GA/%E8%A8%AD%E5%AE%9AUser_id%20.png"></p>

<h3>Step3. 設定View名稱！</h3>

<p>恭喜你 就有新的View !</p>

<h3>Step4. Rails 要怎麼加入 User ID呢？</h3>

<p>如果你跟我一樣是使用Devise gem作為登入的lib，</p>

<h4>Step 1. 在 app/views/layouts/application.html.slim 加上</h4>

<pre><code>= render 'shared/google_analytics', user_id: current_user.try(:id) 
</code></pre>

<p>ps. 若是使用 partial</p>

<pre><code>= render :partial =&gt; "partials/google_analytics" , :locals =&gt; { user_id: current_user.try(:id)}
</code></pre>

<p><em>重點就是那user_id，如果不用try的話，若是current_user是nil，就會報錯！</em></p>

<h4>Step 2. 編輯 app/views/shared/_google_analytics.html.erb</h4>

<pre><code>&lt;script&gt;

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  &lt;%- if user_id.present? %&gt;
    ga('create', 'UA-XXXX-YYYY', {'userId': '&lt;%= user_id %&gt;'})
  &lt;%- else %&gt;
    ga('create', 'UA-XXXX-Y', 'urbox.cc');
  &lt;% end %&gt;
  ga('send', 'pageview');

&lt;/script&gt;
</code></pre>

<h3>那假設user沒有登入，你沒有辦法給他user id</h3>

<p>Google 有推出(工作階段整合) Session Unification的功能，當你啟動了這個功能後，基本上有User ID的就會被放在一個群組，沒有User ID的就會在另外一個群組！</p>

<p>但是厲害的是，Google在同一個session內，若發現這個ID(隨機產生)被重新assign過(系統assign)，他會把之前的action記錄給後來的ID</p>

<h2>那套上User ID後，會有什麼差別呢？</h2>

<ol>
<li><p> 你的指標(metrics)計算方式不同，但是更精確了！</p></li>
<li><p> 你擁有了跨裝置的報告.</p></li>
<li><p> Limited date range.</p></li>
</ol>


<p>  你的Data範圍是90天。</p>
]]></content>
  </entry>
  
</feed>
