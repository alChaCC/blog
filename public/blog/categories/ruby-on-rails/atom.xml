<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Ruby on Rails | AlohaCC]]></title>
  <link href="http://ccaloha.cc/blog/categories/ruby-on-rails/atom.xml" rel="self"/>
  <link href="http://ccaloha.cc/"/>
  <updated>2015-07-22T09:48:02+08:00</updated>
  <id>http://ccaloha.cc/</id>
  <author>
    <name><![CDATA[Aloha]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[For Dummies Stress Test Using JMeter in Rails 4 + Ruby 2.2]]></title>
    <link href="http://ccaloha.cc/blog/2015/07/22/for-dummies-stress-test-using-jmeter-in-rails-4-plus-ruby-2-dot-2/"/>
    <updated>2015-07-22T09:16:12+08:00</updated>
    <id>http://ccaloha.cc/blog/2015/07/22/for-dummies-stress-test-using-jmeter-in-rails-4-plus-ruby-2-dot-2</id>
    <content type="html"><![CDATA[<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/stress%20test/jmeter.png" alt="jmeter generated by ruby-jemer"></p>

<!--more-->


<p>Inspired by</p>

<ol>
<li><a href="http://www.jetthoughts.com/blog/tricks/2014/08/05/stress-testing-your-rails-application-using-jmeter.html">http://www.jetthoughts.com/blog/tricks/2014/08/05/stress-testing-your-rails-application-using-jmeter.html</a></li>
<li><a href="https://github.com/flood-io/ruby-jmeter">https://github.com/flood-io/ruby-jmeter</a></li>
<li><a href="http://jmeter.apache.org/usermanual/get-started.html">http://jmeter.apache.org/usermanual/get-started.html</a></li>
</ol>


<h2>In your local machine (Mac OSX)</h2>

<p>```
brew update
brew install jmeter --with-plugins</p>

<p>```</p>

<h2>In your remote server</h2>

<p>```</p>

<h1>if your want test in remote server</h1>

<p>sudo apt-get install jmeter</p>

<p>```</p>

<h2>Gemfile</h2>

<p>write test plans for JMeter easily</p>

<p>```
gem ruby-jmeter</p>

<p>```</p>

<h2>寫Test Plan</h2>

<p>[Rereference] 語法支援哪些：</p>

<ol>
<li><p><a href="https://github.com/flood-io/ruby-jmeter/blob/5ae25cc32c8d05fcbe32bf143bdfbbd2d657517c/lib/ruby-jmeter/DSL.md">https://github.com/flood-io/ruby-jmeter/blob/5ae25cc32c8d05fcbe32bf143bdfbbd2d657517c/lib/ruby-jmeter/DSL.md</a></p></li>
<li><p>可查看 alies_methods <a href="https://github.com/flood-io/ruby-jmeter/blob/5ae25cc32c8d05fcbe32bf143bdfbbd2d657517c/lib/ruby-jmeter/dsl.rb">https://github.com/flood-io/ruby-jmeter/blob/5ae25cc32c8d05fcbe32bf143bdfbbd2d657517c/lib/ruby-jmeter/dsl.rb</a></p></li>
</ol>


<h3>Write A Stress Test Helper</h3>

<p>```</p>

<h1>test/stress/stress_helper.rb</h1>

<p>require 'ruby-jmeter'</p>

<p>def default_setting(params={})
  domain    = params[:domain]        || 'localhost'
  protocol  = params[:protocol]      || 'https'
  port      = params[:port]          || '3000'
  cookie    = params[:cookie].to_s   || 'true'
  # defaults 會建立jmeter的 "HTTP Request Default"，讓你設定 domain或是 protocol...等數值
  defaults domain: domain, protocol: protocol, port: port</p>

<p>  # cookies 會建立jmeter的 "HTTP Cookie Manager"
  # 如果希望每個threads都有自己的cookie，要將此行code，寫到thread內
  # cookies policy 之前卡了我很久，見註一
  cookies policy: 'compatibility',clear_each_iteration: true unless params[:cookie] == 'false'
end</p>

<h1>Login Helper</h1>

<h1>因為我們登入後會倒回首頁，所以，我有檢查 使用者的名稱是否有出現</h1>

<p>def login(email,pwd,nickname)
  visit name: 'Sign In', url: '/users/sign_in' do</p>

<pre><code># 會抓變數，並且將值assign給 'csrf-token' 與 'csrf-param'
extract name: 'csrf-token', xpath: "//meta[@name='csrf-token']/@content", tolerant: true
extract name: 'csrf-param', xpath: "//meta[@name='csrf-param']/@content", tolerant: true
</code></pre>

<p>  end</p>

<p>  # For devise issue
  http_header_manager name: 'X-CSRF-Token', value: '${csrf-token}'</p>

<p>  # 送出登入
  submit name: 'Submit Sign In form', url: '/users/sign_in',</p>

<pre><code>always_encode: true,
fill_in: {
  'utf8'          =&gt; '✓',
  '${csrf-param}' =&gt; '${csrf-token}',
  'user[email]'        =&gt; email,
  'user[password]'     =&gt; pwd,
  'commit'             =&gt; 'Log in'
} do
# 登入後會倒回首頁，檢查是否包含你的nickname
assert contains: nickname, scope: 'main'
</code></pre>

<p>  end
end
```</p>

<p>註一： cookies policy 之前卡了我很久，因為我發現我登入都會錯誤！都是csrf-token 不相符，我的認知，那是因為Devise使用cookie作為判斷機制，所以cookie policy不能選用<strong>rfc2109</strong>，要選用<strong>compatibility</strong> 他會符合目前幾乎所有線上網站的cookie需求！</p>

<p>Ruby-Jmeter &lt;-> Jmeter</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/stress%20test/ruby-jmeter-mapping-1.png" alt="ruby-jmeter-mapping-1"></p>

<h3>Non Login User Stress Test Plan</h3>

<p>```</p>

<h1>test/stress/non_login.rb</h1>

<p>require './stress_helper'</p>

<p>test do
  default_setting domain: 'your.awesome.website', portocal: 'https' , port: '443'
  #default_setting() # 本機測試使用</p>

<p>  # 壓測，登入後的行為
  # * 使用threads是因為 thread 代表jmeter裡面的thread_group，thread_group就是告訴jmeter
  #   有多少使用者要模擬，多久送一次requests，多少requests要被送出
  # * counts 代表 多少個使用者
  # * rampup 每個使用者的執行間隔
  # * loops 代表多重複做多少次測試</p>

<p>  for i in 1..10</p>

<pre><code>threads count: 20, rampup: 1 ,loops: 1 do
  think_time 5000, 2000
    transaction "活動專區#{i}" do
      # 這邊會去爬 class: 'items' 底下每個 &lt;a&gt; 的href
    # 並且把他assign給 "act-urls"
      visit name: '活動專區首頁', url: "/activities?sort=1&amp;page=#{Random.rand(1..4)}" do 
        extract name: 'act-urls', xpath: "//div[contains(@class,'items')]//a//@href", tolerant: true 
      end
      for i in 1..3
        visit name: "隨便點活動#{i}", url: "${act-urls_#{Random.rand(1..12)}}" do
          extract name: 'product-urls', xpath: "//div[contains(@class,'item-info')]//a//@href", tolerant: true 
        end
      end
    end
  view_results_tree
  debug_sampler
end
</code></pre>

<p>  end</p>

<p>  for i in 1..5</p>

<pre><code>threads count: 20, rampup: 1 ,loops: 1 do
  think_time 5000, 2000
    transaction "活動專區-標籤#{i}" do
      visit name: '活動專區首頁', url: "/activities" do 
        extract name: 'act-tag-urls', xpath: "//div[contains(@class,'keywords')]//a//@href", tolerant: true 
      end
      for i in 1..4
        visit name: "隨便點活動標籤#{i}", url: "${act-tag-urls_#{Random.rand(1..4)}}"
      end
    end
  view_results_tree
  debug_sampler
end
</code></pre>

<p>  end</p>

<p>  view_results_in_table
  graph_results
  aggregate_graph
  view_results_tree
  summary_report</p>

<p>end.run(
  gui: true,
  file: 'jmeter-visitor.jmx',
  log:  'jmeter-visitor.log',
  jtl:  'results-visit.jtl'
)
```
Ruby-Jmeter &lt;-> Jmeter</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/stress%20test/ruby-jmeter-mapping-2.png" alt="ruby-jmeter-mapping-2"></p>

<h3>Login User Stress Test</h3>

<p>```</p>

<h1>test/stress/login.rb</h1>

<p>require './stress_helper'</p>

<p>test do
  default_setting domain: 'your.awesome.website', portocal: 'https' , port: '443'
  # default_setting() # 本機測試使用</p>

<p>  # 壓測，登入後的行為
  threads count: 10, rampup: 1, loops: 1 do</p>

<pre><code>think_time 5000, 2000

transaction 'Log In and View page' do

 login('your@login.account','your-password','your-nickname')

# 這邊會去爬 class: 'ucnh-fs-ls-uctrls' 底下每個 &lt;a&gt; 的href
# 並且把他assign給 "users-urls"
  visit name: 'activity', url: '/activities' do 
    extract name: 'users-urls', xpath: "//div[contains(@class,'ucnh-fs-ls-uctrls')]//a//@href", tolerant: true 
  end
</code></pre>

<p>  # 因為users-urls是個 array，用法就是 ${users-url_X}, X代表array第X個element</p>

<pre><code>  visit name: 'user list1', url: '${users-urls_1}'
  visit name: 'user lists2', url: '${users-urls_3}'
  visit name: 'user lists3', url: '${users-urls_4}'
  visit name: 'user profile', url: '${users-urls_5}'
  visit name: 'user account edit', url: '${users-urls_6}'
end
debug_sampler # 給Debug用
view_results_tree
</code></pre>

<p>  end
  view_results_in_table
  graph_results
  aggregate_graph
  view_results_tree
  summary_report</p>

<p>end.run(
  gui: true,
  file: 'jmeter-after-sign-in.jmx',
  log:  'jmeter-after-sign-in.log',
  jtl:  'results-after-sign-in.jtl'
)
```
Ruby-Jmeter &lt;-> Jmeter</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/stress%20test/ruby-jmeter-mapping-3-submit-form.png" alt="ruby-jmeter-mapping-3-submit-form"></p>

<h2>開始測試</h2>

<p>```
cd your_awesome_projects/test/stress</p>

<h1>ruby 你要執行的.rb檔，ex:</h1>

<p>ruby non_login.rb</p>

<h1>此時會跳出一個apache jmeter的畫面，點選綠色執行按鈕即可</h1>

<p>```</p>

<h2>Others</h2>

<h3>Remove tracking jmeter generated files</h3>

<p>```
echo "/test/stress/<em>.log" >> .gitignore
echo "/test/stress/</em>.jmx" >> .gitignore</p>

<p>```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[HowTo Performance Test in Rails 4]]></title>
    <link href="http://ccaloha.cc/blog/2015/07/14/howto-performance-test-in-rails-4/"/>
    <updated>2015-07-14T19:35:26+08:00</updated>
    <id>http://ccaloha.cc/blog/2015/07/14/howto-performance-test-in-rails-4</id>
    <content type="html"><![CDATA[<p>Inspired by</p>

<ol>
<li><p><a href="http://tekin.co.uk/2014/09/performance-test-rails-against-real-data/">PERFORMANCE TESTING RAILS AGAINST REAL DATA</a></p></li>
<li><p><a href="http://railscasts.com/episodes/411-performance-testing">Performance Testing</a></p></li>
<li><a href="http://railscasts.com/episodes/368-miniprofiler">http://railscasts.com/episodes/368-miniprofiler</a></li>
</ol>


<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/Rails%20performance%20test/rails-perftest%20and%20ruby-prof.png"></p>

<!-- more -->


<h2>First thing you should know</h2>

<p>In Rails 4, performance test functionality was extracted out ! So, you need to add</p>

<pre><code># Gemfile
gem 'rails-perftest' ,group: :benchmark
</code></pre>

<p>And if you want your <strong>rails-perftest</strong> show memory usage. You also need to add</p>

<pre><code># Gemfile
gem 'ruby-prof' ,group: :benchmark
</code></pre>

<p><strong>[! Important !]</strong> In my environment,</p>

<pre><code>rails-4.1.6, ruby-2.2.2.133, x86_64-darwin14
</code></pre>

<p>After doing lots of efforts, I finally can get memory usage info.</p>

<p>But I fount this issue. please check: <a href="https://github.com/ruby-prof/ruby-prof/issues/165">https://github.com/ruby-prof/ruby-prof/issues/165</a>.</p>

<p>And I'm not sure that my memory usage is correct or not.</p>

<p>But I'll still show you how I do these jobs. Maybe after fixing the issue, we can get correct informantion.</p>

<h2>Create a new environment for performance test</h2>

<h3>create a new file:  <strong>config/environments/benchmark.rb</strong></h3>

<p>In fact, all contents are copied from config/environments/production.rb since we need to know performance in real world.</p>

<pre><code>Rails.application.configure do
  # Settings specified here will take precedence over those in config/application.rb.

  # Code is not reloaded between requests.
  config.cache_classes = true

  # Eager load code on boot. This eager loads most of Rails and
  # your application in memory, allowing both threaded web servers
  # and those relying on copy on write to perform better.
  # Rake tasks automatically ignore this option for performance.
  config.eager_load = true

  # Full error reports are disabled and caching is turned on.
  config.consider_all_requests_local       = false
  config.action_controller.perform_caching = true

  # Enable Rack::Cache to put a simple HTTP cache in front of your application
  # Add `rack-cache` to your Gemfile before enabling this.
  # For large-scale production use, consider using a caching reverse proxy like nginx, varnish or squid.
  # config.action_dispatch.rack_cache = true

  # Disable Rails's static asset server (Apache or nginx will already do this).
  config.serve_static_assets = false

  # Compress JavaScripts and CSS.
  config.assets.js_compressor = :uglifier
  # config.assets.css_compressor = :sass

  # Do not fallback to assets pipeline if a precompiled asset is missed.
  config.assets.compile = false

  # Generate digests for assets URLs.
  config.assets.digest = true

  # `config.assets.precompile` and `config.assets.version` have moved to config/initializers/assets.rb

  # Specifies the header that your server uses for sending files.
  # config.action_dispatch.x_sendfile_header = "X-Sendfile" # for apache
  # config.action_dispatch.x_sendfile_header = 'X-Accel-Redirect' # for nginx

  # Force all access to the app over SSL, use Strict-Transport-Security, and use secure cookies.
  config.force_ssl = true

  # Set to :debug to see everything in the log.
  config.log_level = :info

  # Prepend all log lines with the following tags.
  # config.log_tags = [ :subdomain, :uuid ]

  # Use a different logger for distributed setups.
  # config.logger = ActiveSupport::TaggedLogging.new(SyslogLogger.new)

  # Use a different cache store in production.
  # config.cache_store = :mem_cache_store
  config.cache_store = :dalli_store

  # Enable serving of images, stylesheets, and JavaScripts from an asset server.
  # config.action_controller.asset_host = "http://assets.example.com"

  # Ignore bad email addresses and do not raise email delivery errors.
  # Set this to true and configure the email server for immediate delivery to raise delivery errors.
  # config.action_mailer.raise_delivery_errors = false

  # Enable locale fallbacks for I18n (makes lookups for any locale fall back to
  # the I18n.default_locale when a translation cannot be found).
  config.i18n.fallbacks = true

  # Send deprecation notices to registered listeners.
  config.active_support.deprecation = :notify

  # Disable automatic flushing of the log to improve performance.
  # config.autoflush_log = false

  # Use default logging formatter so that PID and timestamp are not suppressed.
  config.log_formatter = ::Logger::Formatter.new

  # Do not dump schema after migrations.
  config.active_record.dump_schema_after_migration = false

end
</code></pre>

<h3>add configuration:  <strong>config/database.yml</strong></h3>

<pre><code>default: &amp;default
  adapter: mysql2
  encoding: utf8
  host: 127.0.0.1
  username: root
  password: your_password

staging:
  &lt;&lt;: *default
  database: your_project_development

development:
  &lt;&lt;: *default
  database: your_project_development

test:
  &lt;&lt;: *default
  database: your_project_test

production:
  &lt;&lt;: *default
  database: your_project_production

benchmark:
  &lt;&lt;: *default
  database: your_project_production 
</code></pre>

<h2>Create a test helper file to setup your benchmark tests:</h2>

<p>create a new file: <strong>test/benchmark_helper.rb</strong></p>

<pre><code>ENV["RAILS_ENV"] = "benchmark"
require File.expand_path('../../config/environment', __FILE__)
require 'rails/test_help'
require 'rails/performance_test_help'

class ActionDispatch::PerformanceTest
   self.profile_options = { runs: 5, metrics: [:wall_time, :memory,:objects, :gc_runs, :gc_time],
                            output: 'tmp/performance', formats: [:flat, :graph_html, :call_tree, :call_stack] }
end
</code></pre>

<h2>Create a test file</h2>

<pre><code>rails generate performance_test page
</code></pre>

<p>and it will create a file named <strong>page.rb</strong> under <strong>test/performance/</strong></p>

<pre><code>require 'benchmark_helper'

class PageTest &lt; ActionDispatch::PerformanceTest
  test "homepage" do
    get '/'
  end
end
</code></pre>

<h2>Add a rake task for running your real-world benchmarks (optional)</h2>

<p>lib/tasks/test_benchmark.rake</p>

<pre><code>Rake::TestTask.new(:real_world_benchmark =&gt; ['test:benchmark_mode']) do |t|
    t.libs &lt;&lt; 'test'
    t.pattern = 'test/performance/**/*_test.rb'
  end
end
</code></pre>

<h2>Update your Rakefile</h2>

<p>Rails 4 no longer defines db:test:prepare, however, <strong>rails-perftest</strong> still use <strong>test:prepare</strong>. So, we need to workaround.</p>

<pre><code>require File.expand_path('../config/application', __FILE__)

Rails.application.load_tasks

Rake.application.instance_eval do
  # Remove test:prepare
  @tasks['test:benchmark'].prerequisites.shift if @tasks['test:benchmark']
  @tasks['test:profile'].prerequisites.shift if @tasks['test:profile']
end
</code></pre>

<h2>For memory measurement, we need the railsexpress patches.</h2>

<p><a href="https://github.com/skaes/rvm-patchsets">https://github.com/skaes/rvm-patchsets</a></p>

<pre><code>rvm get stable
</code></pre>

<p>But my rvm isn't update to date correctly, So I use</p>

<pre><code>cd /tmp
git clone https://github.com/skaes/rvm-patchsets.git
cd rvm-patchsets
./install.sh
</code></pre>

<p>Then I run</p>

<pre><code>rvm reinstall 2.2.2 --patch railsexpress
</code></pre>

<p>After reinstall Ruby, we need to recreate our gemset</p>

<pre><code>cd your_project
rvm gemset create your_project
gem install bundler
bundle install
</code></pre>

<h2>Finally</h2>

<p>These command should work~</p>

<pre><code>RAILS_ENV=benchmark bundle exec rake test:real_world_benchmark
RAILS_ENV=benchmark bundle exec rake test:benchmark
RAILS_ENV=benchmark bundle exec rake test:profile
</code></pre>

<p>Then these command will create some files under <strong>your_project/tmp/performance</strong></p>

<p>PS. Please notice that before performance test, you should make sure that there are no any errors while visit the page.</p>

<h2>Without using "rails-perftest", you might use..</h2>

<h3>if You need detailed information, you can use "request_profiler"</h3>

<p>inspired by <a href="https://www.coffeepowered.net/2013/08/02/ruby-prof-for-rails/">https://www.coffeepowered.net/2013/08/02/ruby-prof-for-rails/</a></p>

<p>we can use <strong>request_profiler</strong>, which allows you to profile rack requests using ruby-prof.</p>

<pre><code>gem 'request_profiler'
</code></pre>

<p>And you might need to add this line into <strong>config/enviornments/benchmark.rb</strong></p>

<pre><code>config.middleware.use "Rack::RequestProfiler"
</code></pre>

<p>On every page you want to profile, just add <strong>?profile_request=true</strong></p>

<p>for example, we want to profile "/" , just key</p>

<pre><code>https://localhost:3000/?profile_request=true
</code></pre>

<p>then you wiil see file named  <strong>2015-07-14-16-49-19---profile_request=true.html</strong> under <strong>tmp/performance/</strong></p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/Rails%20performance%20test/profile_request.png"></p>

<h3>if You need to quickly and easily find out what is bottleneck,  "rack-mini-profiler" is best choice.</h3>

<p><strong>Gemfile</strong></p>

<pre><code>gem 'rack-mini-profiler', require: false  
</code></pre>

<p>Create a new file <strong>config/initializers/rack_profiler.rb</strong></p>

<pre><code>if Rails.env == 'development' || Rails.env == 'benchmark'
  require 'rack-mini-profiler'

  # initialization is skipped so trigger it
  Rack::MiniProfilerRails.initialize!(Rails.application)
end
</code></pre>

<p>Add to <strong>app/controllers/application_controller.rb</strong></p>

<pre><code>before_action :authorize_for_miniprofiler
def authorize_for_miniprofiler
  if Rails.env == 'development' || Rails.env == 'benchmark'
    Rack::MiniProfiler.authorize_request
  end
end
</code></pre>

<p>now you can see this under development and benchmark environments</p>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/Rails%20performance%20test/rack-mini-profiler.png"></p>

<h2>You might want to read</h2>

<ol>
<li><a href="http://code.oneapm.com/ruby/2015/04/08/ruby-profilers/">http://code.oneapm.com/ruby/2015/04/08/ruby-profilers/</a></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sign up by Devise and Crop User Avatar then Upload by Carrierwave using Ruby on Rails]]></title>
    <link href="http://ccaloha.cc/blog/2015/06/25/sign-up-by-devise-and-crop-user-avatar-then-upload-by-carrierwave-using-ruby-on-rails/"/>
    <updated>2015-06-25T01:15:45+08:00</updated>
    <id>http://ccaloha.cc/blog/2015/06/25/sign-up-by-devise-and-crop-user-avatar-then-upload-by-carrierwave-using-ruby-on-rails</id>
    <content type="html"><![CDATA[<p>ref:</p>

<ol>
<li> http://railscasts.com/episodes/182-cropping-images-revised</li>
<li> http://stackoverflow.com/questions/12762728/how-to-crop-image-on-upload-with-rails-carrierwave-and-minimagick</li>
<li> https://coderwall.com/p/e9d_ja/using-carrierwave-uploader-for-tableless-model-in-rails</li>
<li> http://stackoverflow.com/questions/24262388/carrierwave-processing-only-after-the-model-has-been-saved-model-id-is-nil</li>
</ol>


<h1>What I done in this article</h1>

<h2>1. Click Upload Image</h2>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/Crop%20User%20Avatar%20and%20Upload%20via%20Carrierwave%20while%20creating%20user%20using%20Ruby%20on%20Rails/Step1%20click_upload_image.png" alt="Step 1. click_upload_image"></p>

<h2>2. Choose Image And Preview</h2>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/Crop%20User%20Avatar%20and%20Upload%20via%20Carrierwave%20while%20creating%20user%20using%20Ruby%20on%20Rails/Step2%20choose%20image%20and%20preview.png" alt="Step 2. choose image and preview"></p>

<h2>3. Edit Avatar And Preview Image Synchronously</h2>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/Crop%20User%20Avatar%20and%20Upload%20via%20Carrierwave%20while%20creating%20user%20using%20Ruby%20on%20Rails/Step3%20edit%20avatar%20and%20preview%20sync.png" alt="Step 3. Edit Avatar And Preview Image Synchronously"></p>

<h2>4. Upload to AWS S3</h2>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/Crop%20User%20Avatar%20and%20Upload%20via%20Carrierwave%20while%20creating%20user%20using%20Ruby%20on%20Rails/Step4%20upload%20to%20AWS%20S3.png" alt="Step 4. Upload to AWS S3"></p>

<h2>5. Image Cropped And Uploaded</h2>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/Crop%20User%20Avatar%20and%20Upload%20via%20Carrierwave%20while%20creating%20user%20using%20Ruby%20on%20Rails/Step5%20image%20cropped%20and%20uploaded.png" alt="Step 5. Image Cropped And Uploaded"></p>

<!-- more -->


<h1>Steps</h1>

<h2>0. Description</h2>

<p>I use Devise for sign up, Carrierwave for upload image and Jcrop for image selection. There is an User model and user has one UserImage model. Carrierwave uploader is mounted on UserImage. In this tutorial, I'll not go through upload things. You can find lots of resources such as <a href="http://railscasts.com/episodes/253-carrierwave-file-uploads">carrierwave-file-uploads</a>. Also, I'll not show all devise registration and popup(modal) things. Still, there are many resources on the Internet. Ok, let's go.</p>

<h2>1. Gemfile</h2>

<p>I use jcrop for cropping image. So, add jcrop library to <em>Gemfile</em>.</p>

<pre><code>gem 'jcrop-rails-v2'
</code></pre>

<p>ps. don't forgot <strong>bundle install</strong></p>

<h2>2. Model</h2>

<p>In User model, I only need to tell that User has a main image and it refer to UserImage model, and user signup form contains UserImage's attributes, therefore, User model should accept these nested attributes. And I create a method for building image used in upload form(you can see usage in view)</p>

<p><strong>app/models/user.rb</strong></p>

<pre><code>class User &lt; ActiveRecord::Base
  ...
  has_one :main_image, :class_name =&gt; "::UserImage"
    accepts_nested_attributes_for :main_image, reject_if: :all_blank, allow_destroy: true


    def input_main_image
      self.main_image ||= self.build_main_image
      end
  ...
  end
</code></pre>

<p>UserImage model has "file" attribute which is used for upload, and we use carrierwave as our uploader, we need to mount this uploader to "file" attribute. <strong>[!! Important !!] I guess due to Rails work flow, when UserImageUploader upload image, the UserImage custom attributes: crop_x, crop_y, crop_w and crop_h will not available to UserImageUploader that we can't crop image as we want. So we need to skip upload callback first, and we will upload after user is saved.</strong></p>

<p>Ps. if your attribute used for mount uploader named "hello",</p>

<pre><code>mount_uploader :file, UserImagesUploader
skip_callback :save, :after, :store_file!
</code></pre>

<p>will be</p>

<pre><code>mount_uploader :hello, UserImagesUploader
skip_callback :save, :after, :store_hello!
</code></pre>

<p><strong>app/models/user_image.rb</strong></p>

<pre><code># == Schema Information
#
# Table name: user_images
#
#  id                 :integer          not null, primary key
#  user_id            :integer
#  file               :string(255)
#  created_at         :datetime
#  updated_at         :datetime
#

class UserImage &lt; ActiveRecord::Base
  belongs_to :user

    # Used for user avatar image edit
    attr_accessor :crop_x, :crop_y, :crop_w, :crop_h

    mount_uploader :file, UserImagesUploader

    # We need to upload after all attributes assigned，so we skip upload callback first
    skip_callback :save, :after, :store_file!  
end
</code></pre>

<h2>3. View</h2>

<p>In first picture, we have a form for sign up. Due to I have to upload an user image, we need to build it first. Then, UserImage's attributes need to be filled. And I will use some javascript methods for editing so I write some div elements such as "fake-button-upload", "fake-button-edit". Also, I need to popup a image for user editing. Below ".uploaded" codes are used for popup. Finally, you can see I setup some ids, yap~ for javascript.</p>

<p><strong>app/views/users/registrations/new.html.slim</strong></p>

<pre><code>.upload_personal_image
  = f.fields_for :main_image, resource.input_main_image do |build|
    = build.file_field :file, class: "personal-image-upload-file"
    .preview-outer
      = image_tag(resource.main_image.file, id: "preview") if resource.main_image
    .personal-image-upload.icon-default-photo-150x150
    .fake-button-upload 上傳個人照
    .fake-button-edit 編輯大頭照

    .uploaded
      .edit-title 編輯個人照
      = image_tag(resource.main_image.file, id: "preview-edit") if resource.main_image
      .uploaded-image-edit-attr
        - for attribute in [:crop_x, :crop_y, :crop_w, :crop_h]
          = build.text_field attribute, :id =&gt; attribute
      .edit-desc 請將想要顯示的範圍拖曳至中心圓圈處！
      .fake-button-edit-ok 設為個人照
</code></pre>

<h2>4. CSS</h2>

<p><strong>app/assets/stylesheets/front/users/registrations.css.coffee</strong></p>

<p>First we need to require jquery.Jcrop. And, I hope that our crop selector is a circle so I add....</p>

<pre><code>.jcrop-holder div
{
    -webkit-border-radius: 50% !important;
    -moz-border-radius: 50% !important;
    border-radius: 50% !important;
    margin: 0 auto;
    // opacity: 0.6 !important;
}
</code></pre>

<p>You can ignore them but you should notice that some classes are display none such as .personal-image-upload-file,  .preview-outer and .uploaded. These classed will show by javascript control.</p>

<pre><code>//=require jquery.Jcrop

...

.jcrop-holder div
{
    -webkit-border-radius: 50% !important;
    -moz-border-radius: 50% !important;
    border-radius: 50% !important;
    margin: 0 auto;
}

.personal-image-upload-file {
    display: none;
  }

  .preview-outer {
    overflow: hidden;
      display: none;
      width: 150px;
      height: 150px;
      position: absolute;
      left: 0px;
      top: 0px;
      #preview{
        width: 150px;
        height: 150px;
      }
   }
   .uploaded {
  background-color: #FFFFFF;
  text-align: center;
  display: none;
  .edit-title {
    font-size: 20px;
    margin: 0px auto 20px auto;
    padding-top: 30px;
  }
  img {
    border: 1px dashed #dd406f;
    z-index: 2;
  }
  .edit-desc{
    margin-top: 10px;
    margin-bottom: 10px;
    font-size: 14px;
  }

  .uploaded-image-edit-attr{
    display: none;
  }
  .fake-button-edit-ok{
    width: 100px;
    height: 30px;
    font-size: 16px;
    display: inline-block;
    line-height: 30px;
    cursor: pointer;
    background-color: #DD406F;
    border-radius: 3px;
    color: #FFFFFF;
    text-decoration: none;
    margin-bottom: 30px;
  }
}
</code></pre>

<h2>5. Javascript -> most important part for cropping image and previewing image.</h2>

<p>First, we need to require <strong>jquery.Jcrop</strong></p>

<pre><code>#= require jquery.Jcrop
</code></pre>

<p>If user click .personal-image-upload icon or .fake-button-upload button, I'll trigger real upload file click.</p>

<pre><code>$('.personal-image-upload').click -&gt; 
  $('.personal-image-upload-file').trigger('click')

$('.fake-button-upload').click -&gt;
  $('.personal-image-upload-file').trigger('click')
</code></pre>

<p>How to preview image?</p>

<p>First, I have to know original image size since if user don't resize image, I still need to send crop_x, crop_y, crop_w and crop_h to carrierwave crop function. Second, after FileReader read an image, I'll set file path to element #preview and #preview-edit src attribute. Then, I'll hide upload icon and show edit button.</p>

<pre><code>initPreviewImage = -&gt;    
    readURL = (input) -&gt;
      if input.files and input.files[0]
        reader = new FileReader

        reader.onload = (e) -&gt;
          img = new Image
          img.onload = -&gt;
            $('#crop_x').val(0);
            $('#crop_y').val(0);
            $('#crop_w').val(img.width);
            $('#crop_h').val(img.height);
          img.src = e.target.result

          $('.preview-outer').css("display": "inline-block")
          $('#preview').attr 'src', e.target.result
          $('#preview-edit').attr 'src', e.target.result
          $('.personal-image-upload').hide()
          $('.fake-button-edit').css("display": "block")
          $('.fake-button-edit').css("right": "0px")
          $('.fake-button-upload').css("left": "0px")

        reader.readAsDataURL input.files[0]

    $('#user_main_image_attributes_file').change -&gt;
      readURL this
 initPreviewImage();
</code></pre>

<p>At last, the cropping part. I setup three global variables for jcrop_api and image size(boundx, boundy). When the element .fake-button-edit button is clicked, I will call showUserImageEdit() and call my modal method for popup function. In showUserImageEdit function, if jcrop_api already existed(user choose a file already), I have to use jcrop_api to reset new image. And #preview-edit is used for binding jcrop, when user select new area or move selection, it will  call update_crop function to update crop_x, crop_y, crop_w and crop_h(don't forgot these attributes will send to carrierwave uploaded for cropping) and I will update #preview image as well.</p>

<p>Ps. you might ask why rx = 150 / coords.w and ry = 150 / coords.h ? The answer is, I give preview size 150x150px in CSS.</p>

<pre><code>jcrop_api = undefined
  boundx = undefined
  boundy = undefined

  showUserImageEdit = -&gt;
    if jcrop_api
      jcrop_api.setImage($('#preview').attr('src'));

    update_crop = (coords) -&gt;
      rx = 150 / coords.w
      ry = 150 / coords.h
      $('#preview').css
        width: Math.round(rx * boundx) + 'px'
        height: Math.round(ry * boundy) + 'px'
        marginLeft: '-' + Math.round(rx * coords.x) + 'px'
        marginTop: '-' + Math.round(ry * coords.y) + 'px'
      $('#crop_x').val(Math.floor(coords.x));
      $('#crop_y').val(Math.floor(coords.y));
      $('#crop_w').val(Math.floor(coords.w));
      $('#crop_h').val(Math.floor(coords.h));


    $('#preview-edit').Jcrop({
        bgOpacity: 0.4, 
        bgColor: 'black',
        onChange: update_crop,
        onSelect: update_crop,
        allowSelect: true,
        allowResize: true,
        setSelect: [50, 0, 150, 150],
        aspectRatio: 1
      }, -&gt; 
        bounds = this.getBounds();
        boundx = bounds[0];
        boundy = bounds[1];
        jcrop_api = this);
    $('.uploaded').show()
    $('.fake-button-edit-ok').click -&gt; 
      myModal().setTarget($('.uploaded')).close()
      jcrop_api.release()

  initPreviewImageEdit = -&gt;
    $('.fake-button-edit').click -&gt; 
      showUserImageEdit();
      myModal().setTarget($('.uploaded')).open()
  initPreviewImageEdit();
</code></pre>

<p>whole code <strong>app/assets/javascripts/users/registrations.js.coffee</strong></p>

<pre><code>#= require jquery.Jcrop
jQuery -&gt;
  $(document).on 'ready page:load', -&gt; 

    $('.personal-image-upload').click -&gt; 
      $('.personal-image-upload-file').trigger('click')

    $('.fake-button-upload').click -&gt;
      $('.personal-image-upload-file').trigger('click')

    initPreviewImage = -&gt;    
      readURL = (input) -&gt;
        if input.files and input.files[0]
          reader = new FileReader

          reader.onload = (e) -&gt;
            img = new Image
            img.onload = -&gt;
              $('#crop_x').val(0);
              $('#crop_y').val(0);
              $('#crop_w').val(img.width);
              $('#crop_h').val(img.height);
            img.src = e.target.result

            $('.preview-outer').css("display": "inline-block")
            $('#preview').attr 'src', e.target.result
            $('#preview-edit').attr 'src', e.target.result
            $('.personal-image-upload').hide()
            $('.fake-button-edit').css("display": "block")
            $('.fake-button-edit').css("right": "0px")
            $('.fake-button-upload').css("left": "0px")

          reader.readAsDataURL input.files[0]

      $('#user_main_image_attributes_file').change -&gt;
        readURL this
    initPreviewImage();

    jcrop_api = undefined
    boundx = undefined
    boundy = undefined

    showUserImageEdit = -&gt;
      if jcrop_api
        jcrop_api.setImage($('#preview').attr('src'));

      update_crop = (coords) -&gt;
        rx = 150 / coords.w
        ry = 150 / coords.h
        $('#preview').css
          width: Math.round(rx * boundx) + 'px'
          height: Math.round(ry * boundy) + 'px'
          marginLeft: '-' + Math.round(rx * coords.x) + 'px'
          marginTop: '-' + Math.round(ry * coords.y) + 'px'

        $('#crop_x').val(Math.floor(coords.x));
        $('#crop_y').val(Math.floor(coords.y));
        $('#crop_w').val(Math.floor(coords.w));
        $('#crop_h').val(Math.floor(coords.h));


      $('#preview-edit').Jcrop({
          bgOpacity: 0.4, 
          bgColor: 'black',
          onChange: update_crop,
          onSelect: update_crop,
          allowSelect: true,
          allowResize: true,
          setSelect: [50, 0, 150, 150],
          aspectRatio: 1
        }, -&gt; 
          bounds = this.getBounds();
          boundx = bounds[0];
          boundy = bounds[1];
          jcrop_api = this);

      $('.uploaded').show();

      $('.fake-button-edit-ok').click -&gt; 
        myModal().setTarget($('.uploaded')).close()
        jcrop_api.release()

    initPreviewImageEdit = -&gt;
      $('.fake-button-edit').click -&gt; 
        showUserImageEdit();
        myModal().setTarget($('.uploaded')).open()
    initPreviewImageEdit();
</code></pre>

<h2>6. Carrierwave uploader</h2>

<p>As you can see I create a new version named _customize and it only do its job when model(UserImage model) has crop_x, crop_y, crop_w and crop_h attributes. And I use minimagick crop method to crop image before upload.</p>

<pre><code>class UserImagesUploader &lt; CarrierWave::Uploader::Base

  include CarrierWave::MiniMagick

  storage :fog

  ...

  version :_customize, :if =&gt; :customize? do 
    process :crop_img
    resize_to_fill(150, 150)
  end

  def customize? picture
    !model.crop_x.blank? &amp;&amp; !model.crop_y.blank? &amp;&amp; !model.crop_w.blank? &amp;&amp; !model.crop_h.blank?
  end

  def crop_img
    if !model.crop_x.blank? &amp;&amp; !model.crop_y.blank? &amp;&amp; !model.crop_w.blank? &amp;&amp; !model.crop_h.blank?
      manipulate! do |img|
        x = model.crop_x.to_i
        y = model.crop_y.to_i
        w = model.crop_w.to_i
        h = model.crop_h.to_i
        img.crop("#{w}x#{h}+#{x}+#{y}")
        img
      end
    end
  end

  ...

end
</code></pre>

<h2>7. Final step: Upload Image</h2>

<p>Do you remember that I skip upload callback in <strong>app/models/user_image.rb</strong> ?</p>

<pre><code>skip_callback :save, :after, :store_file!  
</code></pre>

<p>So, when should we do upload job?</p>

<p>Answer is after user save !</p>

<pre><code>class Users::RegistrationsController &lt; Devise::RegistrationsController
  after_filter :upload_avatar, :only =&gt; :create

  ... 

  protected

  def upload_avatar
    if resource.persisted? &amp;&amp; resource.main_image # user is created successfuly
      resource.main_image.store_file! 
      resource.main_image.file.recreate_versions!
    end
  end

  ... 
end
</code></pre>

<h2>8. Don't forgot ...</h2>

<p>Since we use Devise for sign up, and we use nested attributes, we need to tell Devise permitted parameters.</p>

<p><strong>app/controllers/applicatio.rb</strong></p>

<pre><code>class ApplicationController &lt; ActionController::Base
  ...
  before_action :configure_permitted_parameters, if: :devise_controller?

  private

  def configure_permitted_parameters
    devise_parameter_sanitizer.for(:sign_up) { |u| u.permit(:email, :password, :password_confirmation, main_image_attributes: ['id', '_destroy', 'file', 'crop_x', 'crop_y', 'crop_w', 'crop_h'])}
  end 
  ... 
end
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[String handling between JavaScript and Ruby]]></title>
    <link href="http://ccaloha.cc/blog/2015/06/10/string-handling-between-javacript-and-ruby/"/>
    <updated>2015-06-10T00:14:49+08:00</updated>
    <id>http://ccaloha.cc/blog/2015/06/10/string-handling-between-javacript-and-ruby</id>
    <content type="html"><![CDATA[<p>javascript 在做 <strong>escape</strong> 時，編碼出來的字，和Ruby的 <strong>CGI.escape</strong>、<strong>URI.escape</strong> 是不同的！</p>

<p>舉例來說：</p>

<p>在<strong>browser console下</strong></p>

<pre><code>escape("台中市")
&gt; "%u53F0%u4E2D%u5E02"
</code></pre>

<p>但是在<strong>rails c</strong> 下</p>

<pre><code>CGI.escape("台中市")
&gt; "%E5%8F%B0%E4%B8%AD%E5%B8%82"
</code></pre>

<p> Why?</p>

<!-- more -->


<p> 查了一下Google，發現是因為在 js 在escape中文時，是將他編成 unicode</p>

<p> 所以，</p>

<h2>javascript 如果要送中文字給Ruby 請使用</h2>

<pre><code>encodeURIComponent("台中市")
&gt; "%E5%8F%B0%E4%B8%AD%E5%B8%82"
</code></pre>

<h2>但是，往往沒辦法你不能去改人家的javascript，你只好.... javascripts escape string to UTF-8</h2>

<p>查到的作法如下：</p>

<p>在<strong>rails c</strong> 下</p>

<pre><code>unicode_str = "%u53F0%u4E2D%u5E02"

unicode_str.gsub(/\%u([\da-fA-F]{4})/) {|m|  [$1].pack('H*').unpack('n*').pack('U*')}

=&gt; "台中市"
</code></pre>

<p> 參數解釋：</p>

<p> 因為 unicode 的字串都是由 %u 開頭，外加上 4個可能是數字可能是 小寫a~f 或是 大寫A~F，所以我們先透過 <strong>gsub</strong> 這個function將符合的字抓出來處理</p>

<p> 抓出來字之後，我們要使用 <strong>pack</strong> 和 <strong>unpack</strong> 方法，來將字進行解碼、編碼</p>

<p> 我們先抓一個字來看，就以 "台" 為例， (ps. <strong>pack 只能用在array, unpack可以用在string</strong>)</p>

<p> gsub 會將 "53F0" 丟進去處理</p>

<pre><code>["53F0"].pack('H*')

  =&gt; "S\xF0"
</code></pre>

<p>  # H: 代表了將他pack組成16進位字(hex string (high nibble first))</p>

<pre><code>"S\xF0".unpack('n*')

=&gt; [21488]
</code></pre>

<p>  # n: 他會return一個 Integer，他代表了16-bit unsigned, network (big-endian) byte order</p>

<pre><code>[21488].pack('U*')

=&gt; "台"
</code></pre>

<p>  # U: 將16位元NBO組成UTF-8</p>

<p> REF: <br/>
 <a href="http://www.cnphp6.com/archives/4967">UNESCAPE編碼錯誤</a></p>

<h2>那反過來呢，要如何將UTF-8的字，做成像 javascript escape 後的結果</h2>

<p>在<strong>rails c</strong>下</p>

<pre><code>return_str = ""
"台中市".each_char { |c| return_str += "%u#{c.unpack("U*").pack("n*").unpack("H*").first}" }


return_str 
&gt; "%u53f0%u4e2d%u5e02"
</code></pre>

<h2>假設，你現在要串接的使用Big5寫的API，你發現他接收的parameters 居然是%A5%78%A4%A4%A5%AB</h2>

<p>因為他default是接受，用 javascript escape Big5編碼的字</p>

<p>所以你要將你UTF-8的字，轉成符合他格式的字</p>

<p>這時候你要這樣做：</p>

<pre><code>  return_str = ""
  Iconv.conv("BIG5", "UTF8", str).unpack("H*").first.scan(/../).each do |s|
    return_str += "%#{s}"
  end
</code></pre>

<p>一樣來看說明：</p>

<pre><code>Iconv.conv("BIG5", "UTF8", "台中市")

=&gt; "\x{A578}\x{A4A4}\x{A5AB}"


Iconv.conv("BIG5", "UTF8", "台中市").unpack("H*")

=&gt; ["a578a4a4a5ab"]

Iconv.conv("BIG5", "UTF8", "台中市").unpack("H*").first.scan(/../)

=&gt; ["a5", "78", "a4", "a4", "a5", "ab"]
</code></pre>

<h2>打完收工！</h2>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Ruby on Rails] Send limited mail on staging environment]]></title>
    <link href="http://ccaloha.cc/blog/2015/04/28/send-limited-mail-on-staging-environment/"/>
    <updated>2015-04-28T17:16:33+08:00</updated>
    <id>http://ccaloha.cc/blog/2015/04/28/send-limited-mail-on-staging-environment</id>
    <content type="html"><![CDATA[<p>For simulating production environment, we will build up a stage machine.</p>

<p>Plus, we usually use the copy of production database in stage server.</p>

<p>In some applications, we will send email to users for some purposes such as confirmation mail after user</p>

<p>register, reset password mail...etc.</p>

<p>And, in staging environment, we have to avoid our operators accidentally send email to real users.</p>

<p>Therefore, we have to implement some codes for filtering.</p>

<p>Let's go</p>

<!-- more -->


<p>According to <a href="http://edgeguides.rubyonrails.org/action_mailer_basics.html#intercepting-emails">Action Mailer Basics</a>, we can register an interceptor to avoid some unexpected actions.</p>

<p>And my requirement is I want staging server can send mail to our employees. In our case, our company mail address is <strong>xxx@itrue.com.tw</strong>. So, we have to implement code that only allow email server send to users like: <strong>XXX@itrue.com.tw</strong>.</p>

<h2>Step1. <em>Gemfile</em></h2>

<pre><code>gem 'settingslogic'
</code></pre>

<h2>Step2. Add a lib on <em>app/lib/settings.rb</em></h2>

<pre><code>class Settings &lt; Settingslogic
    source "#{Rails.root}/config/application.yml"
    namespace Rails.env
end
</code></pre>

<h2>Step3. Add your white list on <em>application.yml</em></h2>

<pre><code>defaults: &amp;defaults
  allowed_send_mail_domain: '@itrue.com.tw'

development:
  &lt;&lt;: *defaults

test:
  &lt;&lt;: *defaults

production:
  &lt;&lt;: *defaults
</code></pre>

<h2>Step4. Write a interceptor on <em>app/interceptor/staging_mail_interceptor.rb</em></h2>

<p>ref: <a href="http://renderedtext.com/blog/2012/04/27/filtering-emails-on-staging/">Filtering emails on staging</a></p>

<pre><code>class StagingMailInterceptor

  def self.delivering_email(message)
    message.to = extract_allowed_recepients(message)
    message.perform_deliveries = false if message.to.empty?
  end

  private

  def self.extract_allowed_recepients(message)
    message.to.select { |address| allowed_address?(address) }
  end

  def self.allowed_address?(address)
    allowed_domains = Settings.allowed_send_mail_domain.split(',')

    matches_allowed = allowed_domains.count { |domain| address.include?(domain) }

    matches_allowed != 0
  end

end
</code></pre>

<h2>Step5. Register interceptor to ActionMailer on <em>app/config/initializers/sandbox_email_interceptor.rb</em></h2>

<pre><code>require 'staging_mail_interceptor'

if Rails.env.staging?
  ActionMailer::Base.register_interceptor(StagingMailInterceptor)
end
</code></pre>

<h2>Done</h2>
]]></content>
  </entry>
  
</feed>
