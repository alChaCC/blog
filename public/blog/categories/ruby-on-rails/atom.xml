<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Ruby_on_Rails | AlohaCC]]></title>
  <link href="http://ccaloha.cc/blog/categories/ruby-on-rails/atom.xml" rel="self"/>
  <link href="http://ccaloha.cc/"/>
  <updated>2014-12-01T01:35:10+08:00</updated>
  <id>http://ccaloha.cc/</id>
  <author>
    <name><![CDATA[Aloha]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[[HOWTO] Using ElasticSearch in Ruby on Rails and setup remote ES server via Vagrant]]></title>
    <link href="http://ccaloha.cc/blog/2014/11/27/howto-using-elasticsearch-in-ruby-on-rails-and-setup-remote-es-server-via-vagrant/"/>
    <updated>2014-11-27T07:45:20+08:00</updated>
    <id>http://ccaloha.cc/blog/2014/11/27/howto-using-elasticsearch-in-ruby-on-rails-and-setup-remote-es-server-via-vagrant</id>
    <content type="html"><![CDATA[<p>首先，要先感謝 "老王"，和 "Marz"哥，給我參考他們的Elasticsearch的文件！</p>

<p>安裝部分，就是參考他們的操作！</p>

<p>這邊最主要的不一樣，是設定遠端的Elasticsearch機器！</p>

<p>改天我會補上 如何實作 "搜尋字詞推薦"，而且是整合soulmate歐！！</p>

<!-- more -->


<h2>Mac本機開發</h2>

<h3>安裝 elastic search</h3>

<pre><code>brew install elasticsearch
</code></pre>

<h3>連結</h3>

<pre><code>ln -sfv /usr/local/opt/elasticsearch/*.plist ~/Library/LaunchAgents
</code></pre>

<h3>啟動</h3>

<pre><code>launchctl load ~/Library/LaunchAgents/homebrew.mxcl.elasticsearch.plist
</code></pre>

<h3>關閉</h3>

<pre><code>launchctl unload ~/Library/LaunchAgents/homebrew.mxcl.elasticsearch.plist
</code></pre>

<h3>Run ElasticSearch</h3>

<pre><code>export JAVA_HOME="/Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Home"
elasticsearch

(或是)

elasticsearch --config=/usr/local/opt/elasticsearch/config/elasticsearch.yml  
</code></pre>

<h3>測試是否安裝成功</h3>

<pre><code>curl -X GET http://localhost:9200
</code></pre>

<p>你應該會看到</p>

<pre><code>{
  "status" : 200,
  "name" : "Rage",
  "version" : {
    "number" : "1.3.2",
    "build_hash" : "dee175dbe2f254f3f26992f5d7591939aaefd12f",
    "build_timestamp" : "2014-08-13T14:29:30Z",
    "build_snapshot" : false,
    "lucene_version" : "4.9"
  },
  "tagline" : "You Know, for Search"
}
</code></pre>

<h3>Code 要加入</h3>

<p>新增一個檔案</p>

<p><strong>lib/tasks/elasticsearch.rake</strong></p>

<p>寫入</p>

<pre><code>require 'elasticsearch/rails/tasks/import'
</code></pre>

<p>修改<strong>Gemfile</strong>，加入</p>

<pre><code>gem 'elasticsearch-rails'
gem 'elasticsearch-model' 
</code></pre>

<h3>跑index</h3>

<p>詳情請參考：<strong>Gem: </strong><a href="https://github.com/elasticsearch/elasticsearch-rails/tree/master/elasticsearch-rails">elasticsearch-rail</a></p>

<pre><code>bundle exec rake environment elasticsearch:import:all
</code></pre>

<p>如果只需要import一個model</p>

<pre><code>bundle exec rake environment elasticsearch:import:model CLASS='Article'
</code></pre>

<p>如果只需要import某些特定的scope</p>

<pre><code>bundle exec rake environment elasticsearch:import:model CLASS='Article' SCOPE='published'
</code></pre>

<h3>清除index</h3>

<pre><code>Article.__elasticsearch__.client.indices.delete index: Article.index_name rescue nil
</code></pre>

<h2>安裝elasticsearch 在Ubuntu 裡面</h2>

<h3>使用vagrant 起三檯機器(用來模擬正式環境)</h3>

<p>請查看前半部</p>

<p><a href="http://ccaloha.cc/blog/2014/09/19/howto-using-sunspot-access-remote-solr-instance-ubuntu-14-dot-04-in-ruby-on-rails-using-vagrant/">HOWTO - Using Sunspot to Access Remote Solr instance(Ubuntu 14.04) in Ruby on Rails Using Vagrant</a></p>

<h3>安裝 elascticsearch</h3>

<pre><code>vagrant ssh search 
sudo apt-get install openjdk-7-jre-headless -y
sudo wget -O - http://packages.elasticsearch.org/GPG-KEY-elasticsearch | sudo apt-key add -
</code></pre>

<h3>編輯source list</h3>

<pre><code>sudo vim /etc/apt/sources.list
</code></pre>

<p>把下面的code放進去</p>

<pre><code>  deb http://packages.elasticsearch.org/elasticsearch/1.3/debian stable main
</code></pre>

<p>繼續安裝</p>

<pre><code>  sudo apt-get update
  sudo apt-get install elasticsearch
  sudo update-rc.d elasticsearch defaults 95 10
  sudo /etc/init.d/elasticsearch start
</code></pre>

<h2>Ruby on Rails 部分</h2>

<h3>更改producion deploy的東東</h3>

<p><strong>config/deploy/production.rb</strong></p>

<pre><code>  role :app, %w{apps@33.33.13.10}
  role :web, %w{apps@33.33.13.10}
  role :db,  %w{apps@33.33.13.11}
  role :crontaber, %w{apps@33.33.13.10}
  set :rails_env, :production
  set :unicorn_rack_env, :production
  set :branch, 'feature/update_search_engine_to_elasticsearch'
</code></pre>

<p>我故意把ip改成 vagrant的ip</p>

<p>另外，branch也用成我自己測試的branch: <strong>feature/update_search_engine_to_elasticsearch</strong></p>

<h2>如何設定將elasticsearch 連到別台機器</h2>

<ol>
<li><p>新增一個 <strong>config/elasticsearch.yml</strong></p>

<pre><code> default: &amp;default
   host: 127.0.0.1:9200

 development:
   &lt;&lt;: *default
   host: 127.0.0.1:9200

 test:
   &lt;&lt;: *default

 production:
   &lt;&lt;: *default
   host: 33.33.13.12:9200
</code></pre></li>
<li><p>在application.rb加入</p>

<pre><code> es = YAML.load(File.open("#{Rails.root}/config/elasticsearch.yml"))[Rails.env]

   elasticsearch_config = {
       host: es["host"],
       transport_options: {
       request: { timeout: 5 }
       },
   }
   Elasticsearch::Model.client = Elasticsearch::Client.new(elasticsearch_config)
</code></pre></li>
<li><p>因為我的product需要做搜尋，所以在Product model 我這樣寫</p></li>
</ol>


<p>  (ps. elasticsearch 真的是博大精深，我沒有時間去深入專研，以下的指令是我try出最符合我需要的搜尋結果，所以大家可參考參考)</p>

<pre><code>def self.essearch(query,sort,page)
  if sort == 'relevance'

    results = __elasticsearch__.search(
      {
        query: {
          filtered: {
            filter: {
              range: { product_price_min: { "gt" =&gt; 0} }
             }, 
            query: {
              bool: {
                must: [
                  multi_match: {
                    query: query,
                    type:  "phrase",
                    fields: ["product_cname^10", "product_ename^10",'product_description', 'product_keyword']
                  }
                ]
              }
            }
          }
        },
        "sort" =&gt; [
          "_score",
          {"product_urcosme_exp" =&gt; {"order" =&gt; "desc"} } 
        ],
        "from" =&gt; (page.to_i-1)*5,
        "size" =&gt; 5          
      }
    )
  else
    # 因為不是精準搜尋，所以這邊的排序就真的會依照我們給他的sort，
    # 但是你總不希望，搜尋面膜，結果第一個結果是：淨膚儀，就因為他的上市時間最晚....囧～
    # 所以，我還是希望第一個看到的結果是以關鍵字有出現的為佳，所以我多使用了filter的功能
    results = __elasticsearch__.search(
      {
        query: {
          filtered: {
            filter: {
              range: { product_price_min: { "gt" =&gt; 0} }
             },
            filter: {
               exists: { field: "product_keyword" }
             },
            query: {
              bool: {
                must: [
                  multi_match: {
                    query: query,
                    type:  "cross_fields",
                    fields: ['product_cname', 'product_ename'],
                    operator:   "and", 
                    #minimum_should_match: '30%'
                  }
                ],
                should: [
                  { match: { "product_description" =&gt;  query}},
                  { match: { "product_keyword" =&gt; query }}
                ],
              }
            }
          }
        },
        "sort" =&gt; [
          {"#{sort}" =&gt; {"order" =&gt; "#{sort == "product_price_min"? 'asc' : 'desc'}"} } , 
           "_score",
          { "product_cname" =&gt; "desc" }
        ],
        "from" =&gt; (page.to_i-1)*5,
        "size" =&gt; 5        
      }
    )
  # 這邊目的是為了如果上面都沒有搜尋結果才做的比較rough的搜尋
  if results.results.size == 0
    results = __elasticsearch__.search(
      {
        query: {
          filtered: {
            filter: {
              range: { product_price_min: { "gt" =&gt; 0} }
             },
            query: {
              bool: {
                must: [
                  multi_match: {
                    query: query,
                    type:  "cross_fields",
                    fields: ['product_cname', 'product_ename','product_description','product_keyword'],
                    operator:   "and"
                  }
                ]
              }
            }
          }
        },
        "sort" =&gt; [
          {"#{sort}" =&gt; {"order" =&gt; "#{sort == "product_price_min"? 'asc' : 'desc'}"} } , 
           "_score",
          { "product_cname" =&gt; "desc" }
        ],
        "from" =&gt; (page.to_i-1)*5,
        "size" =&gt; 5          
      }
    )
  end
  end
  return results
end
</code></pre>

<ol>
<li><p>在product的controller</p>

<p>   @products = Product.essearch(params[:keyword],params[:sort],params[:page])</p>

<p>   @products =  search.results.results</p>

<p> 接下來就是丟給view顯示了～我就不提了～</p></li>
</ol>


<h3>接下來就是deploy加上看看有沒有成功摟</h3>

<pre><code>cap production deploy #因為"config/deploy/production.rb"有改成vagrant設定，所以請放心～
vagrant ssh search    # 登入你的搜尋機器
elasticsearch         # 把elasticsearch 服務跑起來
vagrant ssh app       # 登入跑服務的機器
cd 你的專案            
bundle exec rake environment elasticsearch:import:all  #跑index，這邊如果有成功，代表你已經連過去遠端了！
</code></pre>

<h3>完成！</h3>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[HOWTO] Using Sunspot to access remote Solr instance(Ubuntu 14.04) in Ruby on Rails using Vagrant]]></title>
    <link href="http://ccaloha.cc/blog/2014/09/19/howto-using-sunspot-access-remote-solr-instance-ubuntu-14-dot-04-in-ruby-on-rails-using-vagrant/"/>
    <updated>2014-09-19T20:16:23+08:00</updated>
    <id>http://ccaloha.cc/blog/2014/09/19/howto-using-sunspot-access-remote-solr-instance-ubuntu-14-dot-04-in-ruby-on-rails-using-vagrant</id>
    <content type="html"><![CDATA[<p> 首先，當然要感謝網路上一堆大神的資源</p>

<p> 特別是：</p>

<p> <a href="https://gorails.com/setup/ubuntu/14.04">Setup Ruby On Rails on
Ubuntu 14.04 Trusty Tahr</a></p>

<p><a href="https://gorails.com/deploy/ubuntu/14.04">Deploy Ruby On Rails on
Ubuntu 14.04 Trusty Tahr</a></p>

<p><a href="https://www.digitalocean.com/community/tutorials/how-to-install-solr-on-ubuntu-14-04">How to Install Solr on Ubuntu 14.04</a></p>

<p><a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-redis">How To Install and Use Redis</a></p>

<p><a href="http://gogojimmy.net/2013/05/26/vagrant-tutorial/">[教學]使用Vagrant練習環境佈署</a></p>

<p><a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-memcache-on-ubuntu-14-04">How To Install and Use Memcache on Ubuntu 14.04</a></p>

<p>一開始之前，來說一下，我的目標：</p>

<p>起一台 WEB server 和 Solr server(search engine)，Database則是使用 Mac裡面的 mysql(因為我開發時把DB資料都建在那邊了)，讓這三方彼此co work !</p>

<h2>心得分享</h2>

<blockquote><p>其實本機端的Sunspot他其實也是透過把指令丟給localhost:8983的搜尋引擎做搜尋，現在只是要把丟到localhost:8983換成另外一個遠端的IP。所以，對於Sunspot來說，就是改個config檔。至於做Index的話，我本來以為要讓遠端的搜尋引擎可以access到DB，然後登入到搜尋引擎的機器去設定？。但....根本就不用，一樣，Sunspot已經幫你做掉了，所以基本上，只要你的Rail專案設定的database.yml可以access，Sunspot會自動幫你對應 DB和 遠端的搜尋引擎做index，所以沒有想像中的困難！</p></blockquote>

<p>了解大概流程概念後，那就來實作吧</p>

<h2>使用Vagrant，模擬多機器的環境</h2>

<p>當然要起很多機器，當然是要使用  <strong><a href="https://www.vagrantup.com/">Vagrant</a> + <a href="https://www.virtualbox.org/">VirtualBox</a></strong></p>

<p>那Vagrant的部分，步驟說明就交給Jimmy大大了 <a href="http://gogojimmy.net/2013/05/26/vagrant-tutorial/">[教學]使用Vagrant練習環境佈署</a>！</p>

<p>和Jimmy大大，不一樣的地方大概就是一些有部分調整的lib和script</p>

<p>這邊直接打我的操作流程：</p>

<ol>
<li>下載Vagrant，<a href="http://www.vagrantup.com/downloads">點我到官網下載連結</a></li>
<li>下載Virtual Box，<a href="https://www.virtualbox.org/wiki/Downloads">點我到官網下載</a></li>
<li><p>抓image</p>

<pre><code> vagrant box add Ubuntu-14-04-64bit https://cloud-images.ubuntu.com/vagrant/trusty/current/trusty-server-cloudimg-amd64-vagrant-disk1.box
</code></pre></li>
<li><p>初始化</p>

<pre><code> vagrant init Ubuntu-14-04-64bit
</code></pre></li>
<li><p>把機器Run起來</p>

<pre><code>vagrant up 
</code></pre></li>
<li><p>登入機器</p>

<pre><code>vagrant ssh 
</code></pre></li>
<li><p>安裝Ruby 環境(這邊我有小修一點東西，讓指令跑起來ok)</p>

<pre><code> curl -L https://gist.githubusercontent.com/alChaCC/f1295f5024eb4de71008/raw/bee55fd048b274b40095c6e645aa5ca38721fcc2/bootstrap-chef-solo.sh | sh
</code></pre></li>
<li><p>登出 機器</p>

<pre><code>exit    
</code></pre></li>
<li><p>打包這個Box</p>

<pre><code> vagrant package
</code></pre></li>
<li><p>開一個mobile的box</p>

<pre><code> vagrant box add ubuntu-14_04 package.box
</code></pre></li>
<li><p>設定Vagrantfile 讓你可一次起N檯機器(2014/9/17這是目前最新的設定)</p>

<pre><code> vim Vagrantfile
</code></pre></li>
</ol>


<p>加入：</p>

<pre><code>config.vm.define :app do |app_config|
      app_config.vm.provider :virtualbox do |vb|
        vb.customize ["modifyvm", :id, "--name", "app", "--memory", "1024"]
      end
      app_config.vm.box = "Ubuntu-14-04-64bit"
      app_config.vm.host_name = "app"
      app_config.vm.network "private_network", ip: "33.33.13.10"
  end

  config.vm.define :search do |search_config|
    search_config.vm.provider :virtualbox do |vb|
        vb.customize ["modifyvm", :id, "--name", "search", "--memory", "1024"]
    end
    search_config.vm.box = "Ubuntu-14-04-64bit"
    search_config.vm.host_name = "search"
    search_config.vm.network "private_network", ip: "33.33.13.12"
  end
</code></pre>

<h2>安裝機器.....using Chef ....But</h2>

<p>照理說這邊應該跟得上時代，使用 chef_solo, knife 來安裝才是....</p>

<p>但...由於時間的關係，實在沒時間玩，你懂得～專案還是要Go啊～ 何況是，我必須在兩天之內試出東西</p>

<p>Anyway, 傻人只好用傻方法</p>

<h2>安裝 Rails 環境 在app機器上</h2>

<p>Ruby 2.1.2  + rvm</p>

<ol>
<li><p>登入</p>

<pre><code> vagrant ssh app
</code></pre></li>
<li><p>加上 user</p>

<pre><code> sudo adduser deploy
 sudo adduser deploy sudo
 su deploy
</code></pre></li>
<li></li>
<li><p>安裝基本lib</p>

<pre><code> sudo apt-get update
 sudo apt-get install git-core curl zlib1g-dev build-essential libssl-dev libreadline-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt1-dev libcurl4-openssl-dev python-software-properties
</code></pre></li>
<li><p>安裝rvm</p>

<pre><code> sudo apt-get install libgdbm-dev libncurses5-dev automake libtool bison libffi-dev
 curl -L https://get.rvm.io | bash -s stable
 source ~/.rvm/scripts/rvm
 echo "source ~/.rvm/scripts/rvm" &gt;&gt; ~/.bashrc
 rvm install 2.1.2
 rvm use 2.1.2 --default
 ruby -v
 echo "gem: --no-ri --no-rdoc" &gt; ~/.gemrc
</code></pre></li>
<li><p>安裝Rails</p>

<pre><code> sudo add-apt-repository ppa:chris-lea/node.js
 sudo apt-get update
 sudo apt-get install nodejs
 gem install rails
</code></pre></li>
<li><p>安裝  nginx + Passenger</p>

<pre><code> sudo apt-get install apt-transport-https
 sudo sh -c "echo 'deb https://oss-binaries.phusionpassenger.com/apt/passenger trusty main' &gt;&gt; /etc/apt/sources.list.d/passenger.list"
 sudo chown root: /etc/apt/sources.list.d/passenger.list
 sudo chmod 600 /etc/apt/sources.list.d/passenger.list
 sudo apt-get update
 sudo apt-get install nginx-full passenger
</code></pre></li>
<li><p>修改 nginx 檔案</p>

<pre><code> sudo vim /etc/nginx/nginx.conf
</code></pre>

<p> 加上</p>

<pre><code> passenger_root /usr/lib/ruby/vendor_ruby/phusion_passenger/locations.ini;
 passenger_ruby /home/deploy/.rvm/wrappers/ruby-2.1.2/ruby;
</code></pre></li>
<li><p>修改 Nginx Host</p>

<pre><code> sudo vim /etc/nginx/sites-enabled/default
</code></pre>

<p> 改上</p>

<pre><code> server {
 listen 80 default_server;
 listen [::]:80 default_server ipv6only=on;

 root /home/deploy/我的資料夾名稱/current/public;
 # index index.html index.htm;
 rails_env production;
 passenger_enabled on;
 # Make site accessible from http://localhost/
 server_name 33.33.13.10; # 這邊我讓他跟vagrant機器ip一樣

 error_page   500 502 503 504  /50x.html;
 location = /50x.html {
     root   html;
 }
</code></pre></li>
<li><p>安裝Redis</p>

<pre><code> sudo apt-get install tcl8.5
 wget http://download.redis.io/releases/redis-2.8.9.tar.gz
 tar xzf redis-2.8.9.tar.gz
 cd redis-2.8.9
 make
 make test
 sudo make install
 cd utils
 sudo ./install_server.sh
</code></pre></li>
<li><p>Install memcached</p>

<pre><code> sudo apt-get install mysql-server php5-mysql php5 php5-memcached memcached
 sudo service memcached start
</code></pre></li>
<li><p>安裝mysql</p>

<pre><code>sudo apt-get install mysql-server mysql-client libmysqlclient-dev
</code></pre></li>
</ol>


<h2>安裝 Solr 環境 在search機器上</h2>

<p>我使用tomcat 安裝會有問題(<strong>missing core name in path</strong>)....所以我最後手動安裝</p>

<ol>
<li><p>安裝 java</p>

<pre><code> sudo apt-get -y install openjdk-7-jdk
 mkdir /usr/java
 ln -s /usr/lib/jvm/java-7-openjdk-amd64 /usr/java/default
</code></pre></li>
<li><p>安裝Solr</p>

<pre><code> cd /opt
 wget http://archive.apache.org/dist/lucene/solr/4.7.2/solr-4.7.2.tgz
 tar -xvf solr-4.7.2.tgz
 cp -R solr-4.7.2/example /opt/solr
 cd /opt/solr
 java -jar start.jar
</code></pre></li>
<li><p>編輯 jetty</p>

<pre><code> sudo vim /etc/default/jetty 
</code></pre>

<p> 加入</p>

<pre><code> NO_START=0 # Start on boot
 JAVA_OPTIONS="-Dsolr.solr.home=/opt/solr/solr $JAVA_OPTIONS"
 JAVA_HOME=/usr/java/default
 JETTY_HOME=/opt/solr
 JETTY_USER=solr
 JETTY_LOGS=/opt/solr/logs
</code></pre>

<p> 下指令</p>

<pre><code> vim /opt/solr/etc/jetty-logging.xml
</code></pre>

<p> 加入</p>

<pre><code> &lt;?xml version="1.0"?&gt;
   &lt;!DOCTYPE Configure PUBLIC "-//Mort Bay Consulting//DTD Configure//EN" "http://jetty.mortbay.org/configure.dtd"&gt;
   &lt;!-- =============================================================== --&gt;
   &lt;!-- Configure stderr and stdout to a Jetty rollover log file --&gt;
   &lt;!-- this configuration file should be used in combination with --&gt;
   &lt;!-- other configuration files.  e.g. --&gt;
   &lt;!--    java -jar start.jar etc/jetty-logging.xml etc/jetty.xml --&gt;
   &lt;!-- =============================================================== --&gt;
   &lt;Configure id="Server" class="org.mortbay.jetty.Server"&gt;

       &lt;New id="ServerLog" class="java.io.PrintStream"&gt;
         &lt;Arg&gt;
           &lt;New class="org.mortbay.util.RolloverFileOutputStream"&gt;
             &lt;Arg&gt;&lt;SystemProperty name="jetty.logs" default="."/&gt;/yyyy_mm_dd.stderrout.log&lt;/Arg&gt;
             &lt;Arg type="boolean"&gt;false&lt;/Arg&gt;
             &lt;Arg type="int"&gt;90&lt;/Arg&gt;
             &lt;Arg&gt;&lt;Call class="java.util.TimeZone" name="getTimeZone"&gt;&lt;Arg&gt;GMT&lt;/Arg&gt;&lt;/Call&gt;&lt;/Arg&gt;
             &lt;Get id="ServerLogName" name="datedFilename"/&gt;
           &lt;/New&gt;
         &lt;/Arg&gt;
       &lt;/New&gt;

       &lt;Call class="org.mortbay.log.Log" name="info"&gt;&lt;Arg&gt;Redirecting stderr/stdout to &lt;Ref id="ServerLogName"/&gt;&lt;/Arg&gt;&lt;/Call&gt;
       &lt;Call class="java.lang.System" name="setErr"&gt;&lt;Arg&gt;&lt;Ref id="ServerLog"/&gt;&lt;/Arg&gt;&lt;/Call&gt;
       &lt;Call class="java.lang.System" name="setOut"&gt;&lt;Arg&gt;&lt;Ref id="ServerLog"/&gt;&lt;/Arg&gt;&lt;/Call&gt;&lt;/Configure&gt;
</code></pre></li>
<li><p>加上 User: solr</p>

<pre><code> sudo useradd -d /opt/solr -s /sbin/false solr
 sudo chown solr:solr -R /opt/solr
</code></pre></li>
<li><p>安裝 jetty</p>

<pre><code> sudo wget -O /etc/init.d/jetty http://dev.eclipse.org/svnroot/rt/org.eclipse.jetty/jetty/trunk/jetty-distribution/src/main/resources/bin/jetty.sh
 sudo chmod a+x /etc/init.d/jetty
 sudo update-rc.d jetty defaults
</code></pre></li>
<li><p>跑起來</p>

<pre><code> sudo /etc/init.d/jetty start
</code></pre></li>
<li><p>設定檔</p>

<pre><code> cd /opt/solr/solr
</code></pre></li>
<li><p>把在sunspot改好的schema.xml 寫到這邊</p>

<pre><code> vim /opt/solr/solr/collection1/conf/schema.xml
</code></pre>

<p> 寫上下面那些，因為我要支援中文字詞，所以我有改過一些</p>

<p> 下面這個很重要，如果不改的話，會有連線內容錯誤之類的訊息</p>

<pre><code> &lt;?xml version="1.0" encoding="UTF-8"?&gt;
 &lt;!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
 --&gt;
 &lt;!--  
  This is the Solr schema file. This file should be named "schema.xml" and
  should be in the conf directory under the solr home
  (i.e. ./solr/conf/schema.xml by default) 
  or located where the classloader for the Solr webapp can find it.

  This example schema is the recommended starting point for users.
  It should be kept correct and concise, usable out-of-the-box.

  For more information, on how to customize this file, please see
  http://wiki.apache.org/solr/SchemaXml

  PERFORMANCE NOTE: this schema includes many optional features and should not
  be used for benchmarking.  To improve performance one could
   - set stored="false" for all fields possible (esp large fields) when you
     only need to search on the field but don't need to return the original
     value.
   - set indexed="false" if you don't need to search on the field, but only
     return the field as a result of searching on other indexed fields.
   - remove all unneeded copyField statements
   - for best index size and searching performance, set "index" to false
     for all general text fields, use copyField to copy them to the
     catchall "text" field, and use that for searching.
   - For maximum indexing performance, use the StreamingUpdateSolrServer
     java client.
   - Remember to run the JVM in server mode, and use a higher logging level
     that avoids logging every request
 --&gt;
 &lt;schema name="sunspot" version="1.0"&gt;
   &lt;types&gt;
     &lt;!-- field type definitions. The "name" attribute is
        just a label to be used by field definitions.  The "class"
        attribute and any other attributes determine the real
        behavior of the fieldType.
          Class names starting with "solr" refer to java classes in the
        org.apache.solr.analysis package.
     --&gt;
     &lt;!-- *** This fieldType is used by Sunspot! *** --&gt;
     &lt;fieldType name="string" class="solr.StrField" omitNorms="true"/&gt;
     &lt;!-- *** This fieldType is used by Sunspot! *** --&gt;
     &lt;fieldType name="tdouble" class="solr.TrieDoubleField" omitNorms="true"/&gt;
     &lt;!-- *** This fieldType is used by Sunspot! *** --&gt;
     &lt;fieldType name="rand" class="solr.RandomSortField" omitNorms="true"/&gt;
     &lt;!-- *** This fieldType is used by Sunspot! *** --&gt;
     &lt;fieldType name="text" class="solr.TextField" omitNorms="false"&gt;
       &lt;analyzer&gt;
         &lt;tokenizer class="solr.CJKTokenizerFactory"/&gt;
         &lt;filter class="solr.StandardFilterFactory"/&gt;
         &lt;filter class="solr.LowerCaseFilterFactory"/&gt;
         &lt;filter class="solr.PorterStemFilterFactory"/&gt;
         &lt;filter class="solr.NGramFilterFactory" minGramSize="2" maxGramSize="15"/&gt;
       &lt;/analyzer&gt;

       &lt;analyzer type="query"&gt;
         &lt;tokenizer class="solr.CJKTokenizerFactory"/&gt;
         &lt;filter class="solr.StandardFilterFactory"/&gt;
         &lt;filter class="solr.LowerCaseFilterFactory"/&gt;
       &lt;/analyzer&gt;

     &lt;/fieldType&gt;
     &lt;!-- *** This fieldType is used by Sunspot! *** --&gt;
     &lt;fieldType name="boolean" class="solr.BoolField" omitNorms="true"/&gt;
     &lt;!-- *** This fieldType is used by Sunspot! *** --&gt;
     &lt;fieldType name="date" class="solr.DateField" omitNorms="true"/&gt;
     &lt;!-- *** This fieldType is used by Sunspot! *** --&gt;
     &lt;fieldType name="sdouble" class="solr.SortableDoubleField" omitNorms="true"/&gt;
     &lt;!-- *** This fieldType is used by Sunspot! *** --&gt;
     &lt;fieldType name="sfloat" class="solr.SortableFloatField" omitNorms="true"/&gt;
     &lt;!-- *** This fieldType is used by Sunspot! *** --&gt;
     &lt;fieldType name="sint" class="solr.SortableIntField" omitNorms="true"/&gt;
     &lt;!-- *** This fieldType is used by Sunspot! *** --&gt;
     &lt;fieldType name="slong" class="solr.SortableLongField" omitNorms="true"/&gt;
     &lt;!-- *** This fieldType is used by Sunspot! *** --&gt;
     &lt;fieldType name="tint" class="solr.TrieIntField" omitNorms="true"/&gt;
     &lt;!-- *** This fieldType is used by Sunspot! *** --&gt;
     &lt;fieldType name="tfloat" class="solr.TrieFloatField" omitNorms="true"/&gt;
     &lt;!-- *** This fieldType is used by Sunspot! *** --&gt;
     &lt;fieldType name="tdate" class="solr.TrieDateField" omitNorms="true"/&gt;

     &lt;!-- A specialized field for geospatial search. If indexed, this fieldType must not be multivalued. --&gt;
     &lt;fieldType name="location" class="solr.LatLonType" subFieldSuffix="_coordinate"/&gt;
   &lt;/types&gt;
   &lt;fields&gt;
     &lt;!-- Valid attributes for fields:
      name: mandatory - the name for the field
      type: mandatory - the name of a previously defined type from the
        &lt;types&gt; section
      indexed: true if this field should be indexed (searchable or sortable)
      stored: true if this field should be retrievable
      compressed: [false] if this field should be stored using gzip compression
        (this will only apply if the field type is compressable; among
        the standard field types, only TextField and StrField are)
      multiValued: true if this field may contain multiple values per document
      omitNorms: (expert) set to true to omit the norms associated with
        this field (this disables length normalization and index-time
        boosting for the field, and saves some memory).  Only full-text
        fields or fields that need an index-time boost need norms.
      termVectors: [false] set to true to store the term vector for a
        given field.
        When using MoreLikeThis, fields used for similarity should be
        stored for best performance.
      termPositions: Store position information with the term vector.  
        This will increase storage costs.
      termOffsets: Store offset information with the term vector. This 
        will increase storage costs.
      default: a value that should be used if no value is specified
        when adding a document.
    --&gt;
     &lt;!-- *** This field is used by Sunspot! *** --&gt;
     &lt;field name="id" stored="true" type="string" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This field is used by Sunspot! *** --&gt;
     &lt;field name="type" stored="false" type="string" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This field is used by Sunspot! *** --&gt;
     &lt;field name="class_name" stored="false" type="string" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This field is used by Sunspot! *** --&gt;
     &lt;field name="text" stored="false" type="string" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This field is used by Sunspot! *** --&gt;
     &lt;field name="lat" stored="true" type="tdouble" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This field is used by Sunspot! *** --&gt;
     &lt;field name="lng" stored="true" type="tdouble" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="random_*" stored="false" type="rand" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="_local*" stored="false" type="tdouble" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_text" stored="false" type="text" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_texts" stored="true" type="text" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_b" stored="false" type="boolean" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_bm" stored="false" type="boolean" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_bs" stored="true" type="boolean" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_bms" stored="true" type="boolean" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_d" stored="false" type="date" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_dm" stored="false" type="date" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_ds" stored="true" type="date" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_dms" stored="true" type="date" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_e" stored="false" type="sdouble" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_em" stored="false" type="sdouble" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_es" stored="true" type="sdouble" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_ems" stored="true" type="sdouble" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_f" stored="false" type="sfloat" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_fm" stored="false" type="sfloat" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_fs" stored="true" type="sfloat" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_fms" stored="true" type="sfloat" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_i" stored="false" type="sint" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_im" stored="false" type="sint" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_is" stored="true" type="sint" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_ims" stored="true" type="sint" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_l" stored="false" type="slong" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_lm" stored="false" type="slong" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_ls" stored="true" type="slong" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_lms" stored="true" type="slong" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_s" stored="false" type="string" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_sm" stored="false" type="string" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_ss" stored="true" type="string" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_sms" stored="true" type="string" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_it" stored="false" type="tint" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_itm" stored="false" type="tint" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_its" stored="true" type="tint" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_itms" stored="true" type="tint" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_ft" stored="false" type="tfloat" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_ftm" stored="false" type="tfloat" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_fts" stored="true" type="tfloat" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_ftms" stored="true" type="tfloat" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_dt" stored="false" type="tdate" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_dtm" stored="false" type="tdate" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_dts" stored="true" type="tdate" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_dtms" stored="true" type="tdate" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_textv" stored="false" termVectors="true" type="text" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_textsv" stored="true" termVectors="true" type="text" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_et" stored="false" termVectors="true" type="tdouble" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_etm" stored="false" termVectors="true" type="tdouble" multiValued="true" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_ets" stored="true" termVectors="true" type="tdouble" multiValued="false" indexed="true"/&gt;
     &lt;!-- *** This dynamicField is used by Sunspot! *** --&gt;
     &lt;dynamicField name="*_etms" stored="true" termVectors="true" type="tdouble" multiValued="true" indexed="true"/&gt;

     &lt;!-- Type used to index the lat and lon components for the "location" FieldType --&gt;
     &lt;dynamicField name="*_coordinate"  type="tdouble" indexed="true"  stored="false" multiValued="false"/&gt;
     &lt;dynamicField name="*_p" type="location" indexed="true" stored="true" multiValued="false"/&gt;

     &lt;dynamicField name="*_ll" stored="false" type="location" multiValued="false" indexed="true"/&gt;
     &lt;dynamicField name="*_llm" stored="false" type="location" multiValued="true" indexed="true"/&gt;
     &lt;dynamicField name="*_lls" stored="true" type="location" multiValued="false" indexed="true"/&gt;
     &lt;dynamicField name="*_llms" stored="true" type="location" multiValued="true" indexed="true"/&gt;

     &lt;!-- required by Solr 4 --&gt;
     &lt;field name="_version_" type="string" indexed="true" stored="true" multiValued="false" /&gt;
   &lt;/fields&gt;

   &lt;!-- Field to use to determine and enforce document uniqueness.
       Unless this field is marked with required="false", it will be a required field
    --&gt;
   &lt;uniqueKey&gt;id&lt;/uniqueKey&gt;
   &lt;!-- field for the QueryParser to use when an explicit fieldname is absent --&gt;
   &lt;defaultSearchField&gt;text&lt;/defaultSearchField&gt;
   &lt;!-- SolrQueryParser configuration: defaultOperator="AND|OR" --&gt;
   &lt;solrQueryParser defaultOperator="AND"/&gt;
   &lt;!-- copyField commands copy one field to another at the time a document
         is added to the index.  It's used either to index the same field differently,
         or to add multiple fields to the same field for easier/faster searching.  --&gt;
 &lt;/schema&gt;
</code></pre></li>
<li><p>改好別忘重啟</p>

<pre><code> sudo /etc/init.d/jetty restart
</code></pre></li>
<li><p>但是....目前不是用Chef安裝環境....所以如果要改config檔，就是要到這個地方去修改</p>

<p><strong>/opt/solr/solr/collection1/conf</strong></p></li>
</ol>


<h2>專案上的程式碼</h2>

<ol>
<li>基本上，專案什麼都不用動，因為Sunspot都幫你做掉了</li>
</ol>


<p>你只需要改 <strong>config/sunspot.yml</strong></p>

<p>原先的設定：</p>

<pre><code>production:
  solr:
    hostname: localhost
    port: 8983
    log_level: INFO
    path: /solr/production
    # read_timeout: 2
    # open_timeout: 0.5

development:
  solr:
    hostname: localhost
    port: 8982
    log_level: INFO
    path: /solr/development


test:
  solr:
    hostname: localhost
    port: 8981
    log_level: WARNING
    path: /solr/test
</code></pre>

<p> 把它改成：</p>

<pre><code> production:
  solr:
    hostname: 33.33.13.12
    port: 8983
    log_level: INFO
    path: /solr
    # read_timeout: 2
    # open_timeout: 0.5

development:
  solr:
    hostname: localhost
    port: 8982
    log_level: INFO
    path: /solr/development


test:
  solr:
    hostname: localhost
    port: 8981
    log_level: WARNING
    path: /solr/test
</code></pre>

<p>恭喜完成！</p>

<h2>Capistrano Deployment</h2>

<p>如果你參考我的 Sunspot本機端 Deploy的話，</p>

<p>我試過幾種方法，試著讓app機器，可以去search機器 開關solr....(</p>

<pre><code>sudo /etc/init.d/jetty start
</code></pre>

<p>但是小弟對於Capistrano才疏學淺，實在無法達成</p>

<p>所以我的Deploy Code就先把 solr:start 和 solr:stop 先拿掉</p>

<p>所以原先，我是這樣寫的</p>

<p><strong>/lib/capistrano/taks/sunspot.cap</strong></p>

<pre><code>namespace :deploy do
  before :updated, :setup_solr_data_dir do
    on roles(:app) do
      unless test "[ -d #{shared_path}/solr/data ]"
        execute :mkdir, "-p #{shared_path}/solr/data"
      end
    end
  end
end

namespace :solr do

  %w[start stop].each do |command|
    desc "#{command} solr"
    task command do
      on roles(:app) do
        solr_pid = "#{shared_path}/pids/sunspot-solr.pid"
        if command == "start" or (test "[ -f #{solr_pid} ]" and test "kill -0 $( cat #{solr_pid} )")
          within current_path do
            with rails_env: fetch(:rails_env, 'production') do
              execute :bundle, 'exec', 'sunspot-solr', command, "--port=8983 --data-directory=#{shared_path}/solr/data --pid-dir=#{shared_path}/pids --solr-home=#{release_path}/solr"
            end
          end
        end
      end
    end
  end

  desc "reindex solr"
  task :restart do
    invoke 'solr:reindex'
  end

  after 'deploy:finished', 'solr:restart'

  desc "reindex the whole solr database"

  task :reindex do
    invoke 'solr:stop' 
    on roles(:app) do
      execute :rm, "-rf #{shared_path}/solr/data"
    end
    invoke 'solr:start'
    sleep 10
    on roles(:app) do
      within current_path do
        with rails_env: fetch(:rails_env, 'production') do
          info "Reindexing Solr database"
          execute :bundle, 'exec', :rake, 'sunspot:solr:reindex[,,true]'
        end
      end
    end
  end

end
</code></pre>

<p>現在變成：</p>

<pre><code>namespace :deploy do
  before :updated, :setup_solr_data_dir do
    on roles(:app) do
      unless test "[ -d #{shared_path}/solr/data ]"
        execute :mkdir, "-p #{shared_path}/solr/data"
      end
    end
  end
end

namespace :solr do

  %w[start stop].each do |command|
    desc "#{command} solr"
    task command do
      on roles(:app) do
        solr_pid = "#{shared_path}/pids/sunspot-solr.pid"
        if command == "start" or (test "[ -f #{solr_pid} ]" and test "kill -0 $( cat #{solr_pid} )")
          within current_path do
            with rails_env: fetch(:rails_env, 'production') do
              execute :bundle, 'exec', 'sunspot-solr', command, "--port=8983 --data-directory=#{shared_path}/solr/data --pid-dir=#{shared_path}/pids --solr-home=#{release_path}/solr" # 就算加上 --bind-address=33.33.13.12  也在在本機端跑
            end
          end
        end
      end

      #  嘗試直接從本機去重開 search機器，但是都不work，找解答ing
      #on %w{apps@33.33.13.12} do |host|
      #    as 'apps' do
      #      execute "sudo /etc/init.d/jetty #{command}"
      #    end
      #end
    end
  end

  desc "reindex solr"
  task :restart do
    invoke 'solr:reindex'
  end

  after 'deploy:finished', 'solr:restart'

  desc "reindex the whole solr database"

  task :reindex do
    #invoke 'solr:stop' #這指令是操控本機的solr
    on roles(:app) do
      execute :rm, "-rf #{shared_path}/solr/data"
    end
    #invoke 'solr:start' #這指令是操控本機的solr
    sleep 10
    on roles(:app) do
      within current_path do
        with rails_env: fetch(:rails_env, 'production') do
          info "Reindexing Solr database"
          execute :bundle, 'exec', :rake, 'sunspot:solr:reindex[,,true]'
        end
      end
    end
  end

end
</code></pre>

<h2>恭喜完成！</h2>

<h3>ps. 如果你想要讓在vagrant裡頭app可以存取Mac裡頭的DB</h3>

<p>請把把 host改成 10.0.2.2</p>

<pre><code>host: 10.0.2.2
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[HOWTO] Using Sunspot(Solr) in Rails including easy suggestion feature and deployment to production environment - Part1]]></title>
    <link href="http://ccaloha.cc/blog/2014/09/06/using-sunspot-in-rails-including-suggestion-feature-and-deployment-to-production-machine-part1/"/>
    <updated>2014-09-06T00:06:35+08:00</updated>
    <id>http://ccaloha.cc/blog/2014/09/06/using-sunspot-in-rails-including-suggestion-feature-and-deployment-to-production-machine-part1</id>
    <content type="html"><![CDATA[<p>這系列文章，你可以學到：</p>

<pre><code>1. 如何使用sunspot，作為你的全站全文搜尋
2. 如何使用work around的方式達成sunspot搜尋的推薦字詞 - 利用solmate
3. 如何將sunspot deploy到production 機器，並且自動做index
4. 簡單調整sunspot
</code></pre>

<!-- more -->


<p>首先，當然是要感謝這些文章：</p>

<ol>
<li><p>Jimmy 高手：  <a href="http://gogojimmy.net/2012/01/25/full-text-search-in-rails-with-solr">在 Rails 中使用 Solr 做全文搜尋</a></p></li>
<li><p><a href="http://josephndungu.com/tutorials/fast-autocomplete-search-terms-rails">FAST AUTOCOMPLETE SEARCH TERMS - RAILS</a></p></li>
<li><p><a href="https://gist.github.com/cec/5508303">Capistrano Tasks to setup and interact with SolR and SunSpot</a></p></li>
</ol>


<h1>Part 1. 如何使用sunspot，作為你的全站全文搜尋</h1>

<h2>Step1. 使用gem</h2>

<p>[手做] 修改 <strong>Gemfile</strong></p>

<pre><code>gem 'sunspot_rails'
gem 'sunspot_solr'
</code></pre>

<p>做完後，別忘了</p>

<pre><code>bundle install
</code></pre>

<h2>Step2. 建立sunspot 設定檔</h2>

<pre><code>rails generate sunspot_rails:install
</code></pre>

<p>他會幫你建立 <strong>config/sunspot.yml</strong></p>

<pre><code>production:
 solr:
   hostname: localhost
   port: 8983
   log_level: WARNING
   path: /solr/production
   # read_timeout: 2
   # open_timeout: 0.5

development:
 solr:
   hostname: localhost
   port: 8982
   log_level: INFO
   path: /solr/development

test:
 solr:
   hostname: localhost
   port: 8981
   log_level: WARNING
   path: /solr/test
</code></pre>

<h2>Step3. 在model 建立搜尋功能</h2>

<p>假設我們現在有個 產品的model叫做： <strong>Product</strong> ，我們希望它的產品名稱、描述、價錢、建立時間、是否上架列為我們要搜尋的項目(也是要建index的部分)</p>

<p>所以我們需要在model加上</p>

<pre><code>searchable do
    ....
end
</code></pre>

<p>就像：<strong>app/models/product.rb</strong></p>

<pre><code># == Schema Information
#
# Table name: products
#
#  id                 :integer          not null, primary key
#  name               :string(20)
#  description        :text             not null
#  price              :integer
#  is_on_the_shelf    :boolean
#  created_at                 :datetime
#  updated_at                 :datetime
#

class Product &lt; ActiveRecord::Base  
  searchable do
    text :description,
    string :name
    integer :price
    time :created_at
    boolean :is_on_the_shelf
  end
end
</code></pre>

<h2>Step 4. 在controller建立搜尋動作</h2>

<p>接下來，我們會透過controller來取得view的搜尋字，然後把搜尋結果印出</p>

<p>假設我們希望在每一頁上方都有 搜尋bar給使用者做搜尋，在這邊我是假設用product本身的controller來做</p>

<p>在 <strong>app/controllers/products_controller.rb</strong></p>

<pre><code>class ProductsController &lt; ApplicationController
    def search
        @search = Product.search do
            fulltext params[:keyword] do 
              fields(:description, :name =&gt; 2.0)
              query_phrase_slop 1
            end
            with(:is_on_the_shelf, true)
            with(:created_at).less_than(Time.zone.now)
        end
        @products = @search.results
    end
end
</code></pre>

<p>上面是什麼意思呢？</p>

<p>首先，起手式 - 使用搜尋引擎來做等一下的搜尋</p>

<pre><code>@search = Product.search do
            ....
        end
</code></pre>

<p>再來，</p>

<pre><code>fulltext params[:keyword] do 
    fields(:description, :name =&gt; 2.0) 
    # =&gt; 全文搜尋 描述 和 名稱這兩個欄位，而且，名稱的欄位重要度比較高
    query_phrase_slop 1
    # =&gt; 中間有空一個字也成立，所以 “great big pizza” 也會符合 "great pizza這個字"
end
</code></pre>

<p>最後，條件部分：</p>

<pre><code>with(:is_on_the_shelf, true)  
# =&gt; 我要找所有上架的商品
with(:created_at).less_than(Time.zone.now)
# =&gt; 我要找所有建立時間，小於現在時間的商品
</code></pre>

<p>還有一件事：</p>

<pre><code>@products = @search.results 
# =&gt; 這樣會拿到Array 裡頭有預設 30 個 選出的Product
</code></pre>

<h2>Step 5. 在route建立搜尋link</h2>

<p><strong>config/routes.rb</strong></p>

<pre><code>get '/search', to: 'products#search'
</code></pre>

<h2>Step 6. 建立View</h2>

<pre><code>= form_tag search_path, :method =&gt; :get, class: 'search' do
.input-box
  = text_field_tag :keyword, params[:keyword], class: 'input-search'
  = button_tag "搜尋", class: 'icon-search btn btn-primary'
</code></pre>

<h2>Step 7. 恭喜本機端大致完成，只剩跑起來</h2>

<p>注意歐！這邊要做index歐～ 不然不會生效！</p>

<pre><code>rake sunspot:solr:start
rake sunspot:reindex 
</code></pre>

<p>ps. 當你跑完 <strong>rake sunspot:solr:start</strong>後，你會發現產生很多檔案，基本上我只有追蹤</p>

<p><strong>solr/conf/</strong>*底下的設定檔而已</p>

<h2>Step 7-1. 如果在做index時，你有遇到 “illegal character”</h2>

<p>請加上：</p>

<p><strong>config/initializers/sunspot_fix_illegal_chars.rb</strong></p>

<pre><code>module Sunspot
  # 
  # DataExtractors present an internal API for the indexer to use to extract
  # field values from models for indexing. They must implement the #value_for
  # method, which takes an object and returns the value extracted from it.
  #
  module DataExtractor #:nodoc: all
    # 
    # AttributeExtractors extract data by simply calling a method on the block.
    #
    class AttributeExtractor
      def initialize(attribute_name)
        @attribute_name = attribute_name
      end

      def value_for(object)
        Filter.new( object.send(@attribute_name) ).value
      end
    end

    # 
    # BlockExtractors extract data by evaluating a block in the context of the
    # object instance, or if the block takes an argument, by passing the object
    # as the argument to the block. Either way, the return value of the block is
    # the value returned by the extractor.
    #
    class BlockExtractor
      def initialize(&amp;block)
        @block = block
      end

      def value_for(object)
        Filter.new( Util.instance_eval_or_call(object, &amp;@block) ).value
      end
    end

    # 
    # Constant data extractors simply return the same value for every object.
    #
    class Constant
      def initialize(value)
        @value = value
      end

      def value_for(object)
        Filter.new(@value).value
      end
    end

    # 
    # A Filter to allow easy value cleaning
    #
    class Filter
      def initialize(value)
        @value = value
      end
      def value
        strip_control_characters @value
      end
      def strip_control_characters(value)
        return value unless value.is_a? String

        value.chars.inject("") do |str, char|
          unless char.ascii_only? and (char.ord &lt; 32 or char.ord == 127)
            str &lt;&lt; char
          end
          str
        end

      end
    end

  end
end
</code></pre>

<h1>Part 2. 如何利用solmate使用達成sunspot搜尋的推薦字詞</h1>

<p>因為我實在找不太到 sunspot的設定方法，所以我只好用work around的方式做到這件事情</p>

<p>我是使用 solmate這個 gem 來達成自動推薦。</p>

<p>由於solmate是使用redis當作臨時儲存的空間</p>

<p>若是redis 重啟.....那就gg了，你之前建的推薦資料都會不見。</p>

<p>所以，我有另外新建一個model: <strong>Keyword</strong> 去記錄使用者搜尋過的關鍵字</p>

<p>那就開始吧</p>

<h2>Step 1. 加上Gem</h2>

<p>首先，要先加入gem到 <strong>Gemfile</strong></p>

<pre><code>gem 'rack-contrib'
gem 'soulmate', :require =&gt; 'soulmate/server'
</code></pre>

<p>別忘了</p>

<pre><code>bundle install
</code></pre>

<p>再來你要確保你啟用<strong>redis-server</strong></p>

<pre><code>redis-server
</code></pre>

<h2>Step 2. 建立 Keyword model</h2>

<pre><code>rails g model keyword
</code></pre>

<p>然後 migration檔案：(這邊的結構單純就是為了soulmate設計)</p>

<pre><code>class CreateKeywords &lt; ActiveRecord::Migration
  def change
    create_table :keywords do |t|
        t.string :name
        t.integer :score
        t.string :url
        t.string :subtitle
        t.string :keyword_type
      t.timestamps
    end
  end
end
</code></pre>

<p>別忘了</p>

<pre><code>rake db:migrate
</code></pre>

<h2>Step 3. 將使用者輸入的關鍵字，記錄到solmate和keyword model [重要！]</h2>

<p>還記得，剛剛part 1的 Step 4，基本上我們是將下面的code加進去</p>

<pre><code># 如果有搜尋結果我們在記錄關鍵字 
if @products.present?   
    @keyword = Keyword.find_or_create_by(name: "#{params[:keyword]}") do |k|
        k.score = 0
        k.url = "/search?keyword=#{params[:keyword]}"
        k.keyword_type = "Keyword"
    end
    @keyword.update_attribute(:score, @keyword.score+=1) #代表多搜尋了一次
    remove_from_soulmate(@keyword) #先移除soulmate裡面的記錄
    load_into_soulmate(@keyword)    #更新新的紀錄
end

private

def load_into_soulmate(keyword)
    loader = Soulmate::Loader.new("#{keyword.keyword_type}")
    loader.add("term" =&gt; keyword.name, "id" =&gt; keyword.id, "score" =&gt; keyword.score, "data" =&gt; {
  "link" =&gt; "#{keyword.url}"
  })
end

def remove_from_soulmate(keyword)
    loader = Soulmate::Loader.new("#{keyword.keyword_type}")
    loader.remove("id" =&gt; keyword.id)
end
</code></pre>

<p>所以在 <strong>app/controllers/products_controller.rb</strong>，變成了</p>

<pre><code>class ProductsController &lt; ApplicationController
    def search
        @search = Product.search do
            fulltext params[:keyword] do 
              fields(:description, :name =&gt; 2.0)
              query_phrase_slop 1
            end
            with(:is_on_the_shelf, true)
            with(:created_at).less_than(Time.zone.now)
        end
        @products = @search.results

        # 如果有搜尋結果我們在記錄關鍵字 
        if @products.present?   
            @keyword = Keyword.find_or_create_by(name: "#{params[:keyword]}") do |k|
                k.score = 0
                k.url = "/search?keyword=#{params[:keyword]}"
                k.keyword_type = "Keyword"
            end
            @keyword.update_attribute(:score, @keyword.score+=1) #代表多搜尋了一次
            remove_from_soulmate(@keyword) #先移除soulmate裡面的記錄
            load_into_soulmate(@keyword)    #更新新的紀錄
        end

        private

        def load_into_soulmate(keyword)
            loader = Soulmate::Loader.new("#{keyword.keyword_type}")
            loader.add("term" =&gt; keyword.name, "id" =&gt; keyword.id, "score" =&gt; keyword.score, "data" =&gt; {
          "link" =&gt; "#{keyword.url}"
          })
        end

        def remove_from_soulmate(keyword)
            loader = Soulmate::Loader.new("#{keyword.keyword_type}")
            loader.remove("id" =&gt; keyword.id)
        end
        return @products
    end
end
</code></pre>

<h2>Step 4. 當使用者在輸入關鍵字時，進行推薦</h2>

<p>這邊我們需要借助 js了，這邊我就直接copy上面的參考資料了</p>

<pre><code>var ready = function(){
  var render, select;

  render = function(term, data, type) {
    return term;
  }

  select = function(term, data, type){
    // populate our search form with the autocomplete result
    $('#keyword').val(term);

    // hide our autocomplete results
    $('ul#soulmate').hide();

    // then redirect to the result's link 
    // remember we have the link in the 'data' metadata
    return window.location.href = data.link
  }

  $('#keyword').soulmate({
    url: '/autocomplete/search',
    types: ['keyword'],
    renderCallback : render,
    selectCallback : select,
    minQueryLength : 2,
    maxResults     : 10
  })


}
// when our document is ready, call our ready function
$(document).ready(ready);

// if using turbolinks, listen to the page:load event and fire our ready function
$(document).on('page:load', ready);
</code></pre>

<h2>Step 5. 別忘了，補上 JQUERY 和 SOULMATE.JS</h2>

<p>請參考： https://github.com/mcrowe/soulmate.js</p>

<p>下載：https://github.com/mcrowe/soulmate.js/blob/master/src/compiled/jquery.soulmate.js</p>

<p>因為它屬於第三方資源，所以我是把它放在</p>

<p><strong>vender/assets/javascripts/jquery.soulmate.js</strong></p>

<p>另外別忘了在你global的 <strong>app/assets/javascripts/application.js</strong>確保有</p>

<pre><code>//= require jquery
//= require jquery_ujs
//= require jquery.soulmate
</code></pre>

<h2>Step 6. 還有route</h2>

<p><strong>config/routes.rb</strong></p>

<pre><code>mount Soulmate::Server, :at =&gt; "/autocomplete"
</code></pre>

<h2>Step 7. CSS的部分，就請參考</h2>

<p><a href="http://josephndungu.com/tutorials/fast-autocomplete-search-terms-rails">FAST AUTOCOMPLETE SEARCH TERMS - RAILS</a></p>

<p>待續......</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[HOWTO] 5 steps let your EC website applying GA E-commerce using Ruby on Rails]]></title>
    <link href="http://ccaloha.cc/blog/2014/08/17/5-steps-let-your-ec-website-applying-ga-e-commerce-using-ruby-on-rails/"/>
    <updated>2014-08-17T21:25:55+08:00</updated>
    <id>http://ccaloha.cc/blog/2014/08/17/5-steps-let-your-ec-website-applying-ga-e-commerce-using-ruby-on-rails</id>
    <content type="html"><![CDATA[<p>這篇你會知道如何在 Rails 加上 GA E-commerce的 code</p>

<p>基本上就是參考<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/ecommerce">GA- Ecommerce Tracking - Web Tracking (analytics.js)</a></p>

<p>google 是建議 GATC(google analytic tracking code)可以埋在當使用者完成交易後的感謝頁面</p>

<p>所以，我也是加上訂單created 後的動作，</p>

<p>就讓我們開始吧!</p>

<!-- more -->


<p></p>

<h2>Step 1. Order Controller</h2>

<p>在 <strong>app/controllers/orders_controller.rb</strong></p>

<p>因為需要多一個步驟，所以我是新增一個新的 action，<strong>send_data_to_ga_ec</strong></p>

<pre><code>def send_data_to_ga_ec
    @order = Order.find_by_order_no(params[:id]) 
end
</code></pre>

<h2>Step 2. Route and Controller</h2>

<p>在 <strong>config/routes.rb</strong></p>

<p>因為加了一個action, 所以我補上一條新的routing規則</p>

<pre><code>  get '/orders/send_data_to_ga_ec', :to =&gt; 'orders#send_data_to_ga_ec' 
</code></pre>

<p><em>ps. 注意！一定要放在resource :orders前面，不然會無效</em></p>

<p>回到 <strong>app/controllers/orders_controller.rb</strong></p>

<p>把當訂單完成後，要導向的動作，補上去</p>

<pre><code>def create
    @order = current_user.orders.build(permitted_params.order)
      if @order 
        @order.add_line_items_from_cart(@cart)
            respond_to do |format|
                if @order.save
                    format.html { 
                       redirect_to orders_send_data_to_ga_ec_path(:id =&gt; @order.order_no), notice: "感謝您的訂購，您可以點選[我的訂單]查看訂單資訊，或於幾分鐘後，檢查是否收到訂單確認信"
                    }
                else
                    format.html { render action: 'new' }
                end
            end
        end
end
</code></pre>

<h2>Step 3. View</h2>

<p>這邊就是單純把他購買的東西show出來而已！重點在下兩步！</p>

<pre><code>.home-block 
  h2.home-block-heading
    span  這是您本次的購買資訊

  table.table.cart-table.table-striped.table-bordered.table-hover.span12
        thead
          tr
            th 產品名稱
            th 購買數量
            th 購買顏色
            th 購買尺寸
            th 購買時優惠方案
        tbody
          - @order.line_items.each do |line_item|
              tr
                td= link_to line_item.product.name, product_path(line_item.product.id)
                td= line_item.count
                td= line_item.color
                td= line_item.size
                td= line_item.discount_name
</code></pre>

<h2>Step 4. Application Layout</h2>

<p>因為一般的GATC，我們都是裝在header，所以以Rails來說，就是寫在</p>

<p><strong>app/views/layouts/application.html.slim</strong></p>

<pre><code>  - if controller_name == 'orders' &amp;&amp; action_name == 'send_data_to_ga_ec'
    = render 'shared/google_analytics_ec' , user_id: current_user.try(:id), order: @order
  - else
    = render 'shared/google_analytics' , user_id: current_user.try(:id) 
</code></pre>

<p> 有沒有看到那個 <strong>if controller_name == 'orders' &amp;&amp; action_name == 'send_data_to_ga_ec'</strong></p>

<p> 就是那個讓我判斷說，當這個action時，要load不同的GATC</p>

<h2>Step 5. Partial View - for google_analytics_ec</h2>

<p>要填的參數，我就不再贅述了～ 請看GA 的官方 document</p>

<p><strong>app/views/shared/_google_analytics_ec.html.erb</strong></p>

<pre><code>&lt;script&gt;
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-XXXX-XXX', 'auto');
  &lt;%- if user_id.present? %&gt;
    ga('set', '&amp;uid', &lt;%= user_id %&gt;);
  &lt;% end %&gt;
  ga('require', 'displayfeatures');

  // =========================== GA-Ecommerce Start==========================
  ga('require', 'ecommerce');
  ga('ecommerce:addTransaction', {
    'id': '&lt;%= order.order_no %&gt;',                        // Transaction ID. Required.
    'affiliation': 'Heartbeat',                           // Affiliation or store name.
    'revenue': '&lt;%= order.total_price %&gt;',                // Grand Total.
    'shipping': '&lt;%= order.transaction.ship_fee %&gt;',      // Shipping.
    'tax': '' ,                                           // Tax.
    'currency': 'TWD'                                     // local currency code.
  });

  &lt;% order.line_items.each do |line_item| %&gt;
  ga('ecommerce:addItem', {
    'id': '&lt;%= order.order_no %&gt;',                        // Transaction ID. Required.
    'name': '&lt;%= line_item.product.name %&gt;',              // Product name. Required.
    'sku': '&lt;%= line_item.product.product_no %&gt;',         // SKU/code.
    'category': '&lt;%= line_item.product.tag_list%&gt;',       // Category or variation.
    'price': '&lt;%= line_item.product.selling_price%&gt;',     // Unit price.
    'quantity': '&lt;%= line_item.count%&gt;',                  // Quantity.
    'currency': 'TWD' 
  });
  &lt;% end %&gt;
  ga('ecommerce:send');
  // =========================== GA-Ecommerce End==========================
  ga('send', 'pageview');
&lt;/script&gt;
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[HOWTO] 跳出視窗，內含動態選單]]></title>
    <link href="http://ccaloha.cc/blog/2014/08/08/howto-rails-popup-window-and-ajax-form/"/>
    <updated>2014-08-08T12:40:10+08:00</updated>
    <id>http://ccaloha.cc/blog/2014/08/08/howto-rails-popup-window-and-ajax-form</id>
    <content type="html"><![CDATA[<p>屁話區：</p>

<p>最近要準備開發比較user friendly的後台，於是乎，想到這樣的功能，</p>

<p>於是，我拿了之前開發過的專案來試玩看看～～ 快來看一下中間的眉角～(ps.其實也沒有什麼眉角...都是g來的XDDDD)</p>

<h2>需求描述：</h2>

<p>使用者希望點選"編輯"後，直接popup編輯視窗，裡頭還包含了動態表格</p>

<p>More specific, 來個簡單使用者情境：</p>

<blockquote><p>後台管理人員，需要幫其中一張訂單，加購商品</p></blockquote>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/%5Bhowto%5D%20%E8%B7%B3%E5%87%BA%E8%A6%96%E7%AA%97%EF%BC%8C%E5%85%A7%E5%90%AB%E5%8B%95%E6%85%8B%E9%81%B8%E5%96%AE/popup%E8%A6%96%E7%AA%97.png" alt="加購商品跳出視窗"></p>

<p>就讓我們繼續看下去....這崮中有什麼訣竅～～～～</p>

<!-- more -->


<p>在文章的開始，當然要先感謝前人的知識、還有一堆Open Source</p>

<h2>REF</h2>

<p><a href="http://ericlondon.com/2014/03/13/rails-4-submit-modal-form-via-ajax-and-render-js-response-as-table-row.html">Rails 4 submit modal form via AJAX and render JS response as table row</a></p>

<p><a href="http://www.petermac.com/rails-3-jquery-and-multi-select-dependencies/">Rails 3, jQuery and multi-select dependencies</a></p>

<p><a href="http://getbootstrap.com/javascript/#modals">Bootstrap- modal.js</a> => 用來做popup視窗</p>

<p><a href="http://ivaynberg.github.io/select2/">Selec2 js</a> => 用來做動態選資料</p>

<h1>流程</h1>

<ol>
<li>管理人員在後台，訂單的list頁，有一個加購的button</li>
<li>點選這個button後，會跳出一個視窗</li>
<li>視窗裡面有一個表格，上面會預先帶入這個訂單的ID，還有一個產品編號的select功能</li>
<li>當管理人員慢慢打字輸入了產品編號，系統會自動搜尋可能的結果</li>
<li>選擇了一個產品編號，底下會自動跳出這個加購的資訊，例如：顏色、尺寸、數量</li>
</ol>


<p>ps. 我的View是使用slim</p>

<h1>流程一：管理人員在後台，訂單的list頁，有一個加購的button</h1>

<p>你可能會有一個訂單清單</p>

<p>在 <em>app/views/orders/index.html.slim</em> 你只要加上</p>

<pre><code>= link_to '加購', '#add_product_modal', 'data-toggle' =&gt; 'modal', class: 'btn 
btn-mini', 'data-order' =&gt; order.id
</code></pre>

<p><strong>重點是那個'data-toggle' => 'modal'</strong> => 加了就有modal的功效歐～～</p>

<p>還有另外一個伏筆，那個 'data-order' => order.id</p>

<p>慢慢讀下去你就會知道那個要幹嘛了！</p>

<p>大概可能會長這樣</p>

<pre><code>- @orders.each do |order|
    = ...
    = link_to '加購', '#add_product_modal', 'data-toggle' =&gt; 'modal', class: 'btn btn-mini', 'data-order' =&gt; order.id
</code></pre>

<p>ps. 這邊你可能會有個疑惑，囧～這個link_to 怎麼沒有 link to 的位置?! 人客啊～不要急～讓我們繼續看下去</p>

<h3>成果：</h3>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/%5Bhowto%5D%20%E8%B7%B3%E5%87%BA%E8%A6%96%E7%AA%97%EF%BC%8C%E5%85%A7%E5%90%AB%E5%8B%95%E6%85%8B%E9%81%B8%E5%96%AE/%E8%A8%82%E5%96%AElist.png" alt="訂單list"></p>

<h1>流程二：點選這個button後，會跳出一個視窗</h1>

<p>在 <em>app/views/orders/index.html.slim</em> 繼續加上，我是把它加在最底下，不過你也可以考慮拉出一個partial view，depend on you摟～</p>

<p>不要覺得好像很厲害(但是寫這個套件很厲害!)～這一串是從Modal官網看到的sample，只是把它拿出來用而已</p>

<pre><code>.modal.fade#add_product_modal tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"
  .modal-dialog
    .modal-content
      .modal-header
        button.close type="button" data-dismiss="modal" aria-hidden="true"
          | &amp;times;
        h4.modal-title#myModalLabel
          | 加購產品
      .modal-body
        = render 'extra_buy_form' 
      .modal-footer
        button type="button" class="btn btn-default" data-dismiss="modal"
          | 關閉
</code></pre>

<p>這裡頭有ㄧ個關鍵，就是那個跳出來視窗，裡頭的內容(在我們的例子，也就是表格)</p>

<p>我把它寫成 partial view: <strong>extra_buy_form</strong></p>

<p>其他的東東，我想看那個class name就知道了吧～</p>

<h2>流程二 - 1 既然都已經寫好modal，那當然要記得要有他的js歐～不然不會有效果</h2>

<p>加入在<em>app/assets/javascripts/admin.js</em> (這是因為我的admin有自己的版，裡頭會抓admin.js)</p>

<pre><code>//= require bootstrap.min 
</code></pre>

<h1>流程三：視窗裡面有一個表格，上面會預先帶入這個訂單的ID，還有一個產品編號的select功能</h1>

<p>這邊就進到了，<strong>extra_buy_form</strong>的部分，</p>

<p>由於是在order底下，所以我的檔案是建立在 <em>app/views/admin/orders/_extra_buy_form.html.slim</em></p>

<pre><code>= simple_form_for :line_item,:url =&gt; update_extra_buy_admin_orders_path, defaults: { input_html: { remote: true, 'data-model' =&gt; 'product'}}do |f|
  = f.input :order_id,  label: '加入訂單編號：'
  = f.input :product_id, input_html: {class: 'form-control', data: {product_selector: 'true'} }
  #buying_detail
  .text-center.small-padding
    = submit_tag '送出', disabled_with: '送出中', class: 'btn block-btn'
</code></pre>

<p>這邊有幾個點要講：</p>

<ol>
<li>由於我們這個不屬於orde model的屬性，也沒有任何 instance variable (例如：@line_item)被帶入，所以simple_form 我是使用 symbol (:) 來表示</li>
<li>再來，那個url，就代表著等一下這張表格會被 post到哪裡，等下會說明 order controller的部分和route</li>
<li>第三行，就是要用select2 來實作的動態select內容的寫法，最重要的是那個：data: {product_selector}</li>
<li>第四行非常重要的！ 當你選完產品id後，這邊就會render出這個產品的相關資訊，等一下會介紹到！！！</li>
<li>那個order_id，嘿嘿～～ 等一下流程五會提到！</li>
</ol>


<h2>流程四：當管理人員慢慢打字輸入了產品編號，系統會自動搜尋可能的結果</h2>

<p>這邊就是select2的實作！</p>

<p>首先，先建立一個js吧～ <em>app/assets/javascripts/admin/proudct_selector.js.coffee</em></p>

<pre><code>jQuery ($) -&gt;
  $(document).on 'ready page:load', -&gt;
    $('[data-product-selector]').each -&gt;
      $this = $(this)
      $this.select2(
        placeholder: "輸入產品編號"
        minimumInputLength: 0
        allowClear: true

        ajax:
          url: '/admin/products/get_product_list.json'
          data: (term, page) -&gt; q: term
          results: (data, page) -&gt; results: data

        initSelection: (element, callback) -&gt;
          if $this.val() isnt ''
            $.ajax(
              url: "/admin/products/#{$this.val()}.json"
              success: (data) -&gt; callback(data)
            )
      )
</code></pre>

<p>這邊有幾個點要講：</p>

<ol>
<li><strong>$('[data-product-selector]')</strong> 就是找到 這個 => <strong>data: {product_selector}</strong></li>
<li><strong>url: '/admin/products/get_product_list.json'</strong> => 這邊要去跟controller要資料</li>
<li><strong>url: "/admin/products/#{$this.val()}.json"</strong> => 這邊其實用不太到，不過，如果你可能會有預設值的話，譬如說，你是某個form 可以給人家編輯</li>
</ol>


<h3>成果：</h3>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/%5Bhowto%5D%20%E8%B7%B3%E5%87%BA%E8%A6%96%E7%AA%97%EF%BC%8C%E5%85%A7%E5%90%AB%E5%8B%95%E6%85%8B%E9%81%B8%E5%96%AE/select2%20serarch%E5%8A%9F%E8%83%BD.png" alt="select2 search"></p>

<h2>流程四 - 1：既然這邊用到了select2、還有你自己寫的js，別忘了....</h2>

<p>加入在<em>app/assets/javascripts/admin.js</em> (這是因為我的admin有自己的版，裡頭會抓admin.js)</p>

<pre><code>//= require select2
//= require admin/product_selector
</code></pre>

<h2>流程四 - 2：剛剛提到說兩個 admin/products/XXX.json 就是要跟controller拿資料，所以當然我們要新增action給他摟</h2>

<p>請加在： <em>app/controllers/admin/products_controller.rb</em></p>

<p>首先</p>

<pre><code>def serial_products(products)
    products.map { |p| {id: p.id, text: p.product_no}}
end

def show 
    @product = Product.find(params[:id])

    respond_to do |f|
        f.html
        f.json { render json: serial_products(@product) } #要給ajax使用
    end
end
</code></pre>

<p>再來</p>

<pre><code>def get_product_list
    @products = if params[:q]
                    Product.on_sale.filter_by(params[:q])
                else
                    Product.on_sale
                end
    respond_to do |f|
        f.json { render json: serial_products(@products)} #只給ajax使用
    end
end
</code></pre>

<p>重要的眉角：</p>

<pre><code>if params[:q]
    Product.on_sale.filter_by(params[:q])
...
</code></pre>

<p>為甚麼要有這個呢？</p>

<p>那是因為<em>app/assets/javascripts/admin/proudct_selector.js.coffee</em>這個js不是有一個</p>

<pre><code>url: '/admin/products/get_product_list.json'
data: (term, page) -&gt; q: term
</code></pre>

<p>有沒有看到那個 “q“</p>

<p>沒錯！ 就是那個q，他會丟一個param[:q]的值給get_product_list，</p>

<p>也就是這個，我們就可以達成 <strong>慢慢打字輸入了產品編號，系統會自動搜尋可能的結果</strong></p>

<h2>流程四 - 3： 從上一個步驟(四-3)裡頭有"Product.on_sale.filter_by"，這邊是model的方法</h2>

<p>我們來看一下model，並加在 <em>app/models/product.rb</em></p>

<pre><code>scope :on_sale, -&gt; {where(is_added: true)}
scope :filter_by, lambda { |q| where('product_no LIKE :qurey', qurey: "%#{q}%") }
</code></pre>

<p>這邊小眉角：</p>

<pre><code>where('product_no LIKE :qurey', qurey: "%#{q}%")
</code></pre>

<p>這個就是rails用來做 like搜尋(我把它稱作模糊搜尋，不知道有沒有錯)</p>

<h2>流程四 - 4： 既然controller都寫完了，別忘記route歐！</h2>

<p>要改：<em>config/routes.rb</em></p>

<pre><code>namespace :admin do

  ...

  resources :products do
    ...

    collection { get :get_product_list}
  end

  resources :orders do
    ...
    collection { post :update_extra_buy }
  end

  ....

end
</code></pre>

<h1>流程五：選擇了一個產品編號，底下會自動跳出這個加購的資訊，例如：顏色、尺寸、數量</h1>

<p>這邊我們要來看，<em>app/views/admin/orders/_extra_buy_form.html.slim</em></p>

<p>裡面的</p>

<pre><code>  #buying_detail
</code></pre>

<p>怪怪....為甚麼這一行，就可以讓它自動跳出加購的資訊？！</p>

<p>接下來厲害了！！</p>

<h2>流程五-1：表格上面select 也已經動態可以選了，那底下的動態表格，怎麼沒有render出來？！</h2>

<p>這邊 我們必須使用一個javascript來監控那個select2的行為， 不過貌似可以寫在select2裡面，但是...我是覺得怪怪的～應該要猜開才是(ps. 其實是我不太會寫XDDDD)</p>

<p>沒錯！ 我們需要新增 <em>app/assets/admin/order.js</em></p>

<pre><code>jQuery(function($) {
  // when the #data-product-selector field changes
  $("[data-product-selector]").change(function() {
    var product_id = $('[data-product-selector]').val();
    if(product_id == "") product_id="0";
    var product = 'product_id='+ product_id;
    jQuery.get("/admin/products/update_product_atts",product, function(data){
        $("#buying_detail").html(data);
    })
    return false;
  });

  $(document).on('click', '[data-toggle=modal]', function(e) {
    $('#line_item_order_id').val(e.target.getAttribute('data-order'));
  });

})
</code></pre>

<p>重點：</p>

<p>1.jQuery.get("/admin/products/update_product_atts",product, function(data){</p>

<pre><code>        $("#buying_detail").html(data);
    })
</code></pre>

<p>我覺得 可以算是本日最精彩！</p>

<p>第一次知道原來partial view可以這樣用！！！！</p>

<p>等一下在講那個update_product_atts</p>

<p>2.<strong>$('#line_item_order_id').val(e.target.getAttribute('data-order'));</strong></p>

<p>這個是為了那個pop視窗 <em>app/views/admin/orders/_extra_buy_form.html.slim</em> 的裡頭預設的order id值</p>

<pre><code>= simple_form_for :line_item,:url =&gt; update_extra_buy_admin_orders_path, defaults: { input_html: { remote: true, 'data-model' =&gt; 'product'}}do |f|
  = f.input :order_id,  label: '加入訂單編號：'
</code></pre>

<p>為甚麼會有 <strong>e.target.getAttribute('data-order')</strong></p>

<p>那是因為，我希望直接知道 使用者點的是那張訂單，所以.... 還記得....</p>

<p>在 <em>app/views/orders/index.html.slim</em> 你只要加上</p>

<pre><code>= link_to '加購', '#add_product_modal', 'data-toggle' =&gt; 'modal', class: 'btn 
btn-mini', 'data-order' =&gt; order.id
</code></pre>

<p>有沒有看到'data-order' => order.id</p>

<p>所以那段js只是把 值抓出來而已，然後再餵給 <strong>f.input :order_id</strong></p>

<h2>流程五-2：/admin/products/update_product_atts 、$("#buying_detail").html(data) 在搞什麼鬼？</h2>

<p>其實從js來看，就會知道他就是要跟 products controller拿東東</p>

<p>所以，繼續來編輯我們的 <em>app/controllers/admin/products_controller.rb</em></p>

<pre><code> def update_product_atts
        product = Product.find(params[:product_id]) unless params[:product_id].blank?
        render :partial =&gt; "admin/orders/product_attrs", :locals =&gt; { :product =&gt; product} #這邊還挺酷的，只會render那個partial頁面
 end
</code></pre>

<p>還有view歐  <em>app/views/admin/order/_product_attrs.html.slim</em></p>

<pre><code>- if product.present?
  = simple_form_for :line_item_attr, defaults: { input_html: { remote: true, url: '#'}} do |f|
    = f.input :color, label: '顏色：' , collection: "#{product.color}".split(",").map(&amp;:to_s)
    = f.input :size, label: '尺寸：', collection: "#{product.size}".split(",").map(&amp;:to_s)
    = f.input :count, label: '數量：' , collection: (1..50), selected: '1'
</code></pre>

<p>有沒有看到～ 那個</p>

<p><strong>jQuery.get("/admin/products/update_product_atts",product</strong></p>

<p>就是會丟出一個 params[:product_id] 給 product controller</p>

<p>當controller 抓到 id 後，就把那個product 資料，依照  admin/orders/product_attrs 樣子render給data，然後讓</p>

<pre><code>$("#buying_detail").html(data); 
</code></pre>

<p>把資料畫出來</p>

<p>傑克！這實在太神奇了！！！！！！！！！！！！</p>

<h3>成果：</h3>

<p><img src="https://dl.dropboxusercontent.com/u/22307926/Blog%20Image/%5Bhowto%5D%20%E8%B7%B3%E5%87%BA%E8%A6%96%E7%AA%97%EF%BC%8C%E5%85%A7%E5%90%AB%E5%8B%95%E6%85%8B%E9%81%B8%E5%96%AE/%E8%87%AA%E5%8B%95%E5%B8%B6%E5%87%BAform.png" alt="select2 search"></p>

<h2>流程五-3：既然你自己寫的js，別忘了....</h2>

<p>加入在<em>app/assets/javascripts/admin.js</em> (這是因為我的admin有自己的版，裡頭會抓admin.js)</p>

<pre><code>//= require admin/orders
</code></pre>

<h2>打完收工！</h2>
]]></content>
  </entry>
  
</feed>
